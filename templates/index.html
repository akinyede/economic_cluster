<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KC Economic Cluster Prediction Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="/static/css/ui_enhancements.css" rel="stylesheet" />
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/security-helpers.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
      .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
      }
      .card {
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .metric-card {
        text-align: center;
        padding: 2rem;
      }
      .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
      }
      .metric-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
      }
      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
      }
      .status-pending {
        background-color: #fff3cd;
        color: #856404;
      }
      .recommendation-card {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        margin-bottom: 1rem;
      }
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .cluster-detail-card {
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
      }

      .ml-predictions {
        background-color: #e3f2fd;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }

      .network-metrics {
        background-color: #f0f4c3;
        padding: 1rem;
        border-radius: 0.5rem;
      }

      .ml-insight-card {
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f3e5f5;
        border-radius: 0.5rem;
      }

      .ml-insight-card h5 {
        color: #6a1b9a;
        margin-bottom: 0.5rem;
      }

      .ml-insight-card ul {
        margin-left: 1.5rem;
        margin-bottom: 0;
      }
      
      /* Map container styling */
      #mapContainer {
        position: relative;
        width: 100%;
        height: 500px;
        min-height: 500px;
        overflow: hidden;
      }
      
      #mapContainer iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }
      
      /* Enhanced Metrics Styles */
      .enhanced-metrics {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      
      .enhanced-metrics h6 {
        color: #1976d2;
        margin-bottom: 12px;
        font-weight: 600;
      }
      
      .enhanced-metrics p {
        margin-bottom: 8px;
        font-size: 0.9rem;
      }
      
      .enhanced-metrics strong {
        color: #333;
      }
      
      /* SBIR Analysis Styles */
      .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        margin-bottom: 15px;
      }
      
      .metric-card h5 {
        color: #666;
        font-size: 1rem;
        margin-bottom: 10px;
      }
      
      .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1976d2;
        margin: 0;
      }
      
      /* Cluster Detail Card Enhancement */
      .cluster-detail-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #ffffff;
      }
      
      .cluster-detail-card h5 {
        color: #1976d2;
        margin-bottom: 15px;
      }
      
      .cluster-detail-card .col-md-6,
      .cluster-detail-card .col-md-4 {
        margin-bottom: 15px;
      }
      
      /* Natural Communities Accordion Styles */
      .community-card {
        border: 1px solid #e0e7ff;
        transition: all 0.3s ease;
      }
      
      .community-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }
      
      .community-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      
      .community-header:hover {
        background-color: #e9ecef;
        border-bottom-color: #007bff;
      }
      
      .community-header[aria-expanded="true"] {
        background-color: #e3f2fd;
        border-bottom-color: #007bff;
      }
      
      .community-header h5 {
        margin: 0;
        padding: 0.75rem 0;
        user-select: none;
      }
      
      .collapse-indicator {
        font-size: 14px;
        color: #6c757d;
      }
      
      .community-header[aria-expanded="true"] .collapse-indicator {
        transform: rotate(180deg);
      }
      
      #naturalCommunitiesAccordion .card-body {
        background-color: #fafbfc;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-header">
      <div class="container">
        <h1>Kansas City Economic Cluster Prediction Tool</h1>
        <p class="lead">AI-Powered Economic Development Analysis</p>
      </div>
    </div>

    <div class="container">
      <!-- Analysis Mode Selector -->
      <div
        class="card mb-3"
        style="border: 2px solid #e3f2fd; background-color: #f8f9fa"
      >
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              <i class="fas fa-tachometer-alt"></i> Analysis Mode
            </h5>
            <span class="badge bg-info" id="estimatedTime">~5 minutes</span>
          </div>

          <div class="btn-group w-100" role="group">
            <input
              type="radio"
              class="btn-check"
              name="analysisMode"
              id="quickMode"
              autocomplete="off"
              checked
            />
            <label class="btn btn-outline-primary" for="quickMode">
              <i class="fas fa-bolt"></i> Quick Analysis
              <small class="d-block">ML-powered insights in minutes</small>
            </label>

            <input
              type="radio"
              class="btn-check"
              name="analysisMode"
              id="fullMode"
              autocomplete="off"
            />
            <label class="btn btn-outline-primary" for="fullMode">
              <i class="fas fa-microscope"></i> Full Analysis
              <small class="d-block">Comprehensive deep dive (2-3 hours)</small>
            </label>
          </div>

          <div class="alert alert-info mt-3 mb-0" id="modeInfo">
            <small
              ><strong>Quick Mode:</strong> Fast analysis with smart patent search (top 2000 businesses),
              ML-powered discovery</small
            ><br />
            <small
              ><strong>Full Mode:</strong> Comprehensive analysis of all 358,133 businesses,
              complete patent coverage</small
            >
          </div>
        </div>
      </div>

      <!-- Quick Start Guide -->
      <div class="quick-guide">
        <h5><i class="fas fa-rocket"></i> Quick Start Guide</h5>
        <div class="row">
          <div class="col-md-8">
            <ul>
              <li>
                <strong
                  >Required fields are marked with a red asterisk (*)</strong
                >
              </li>
              <li>
                For your first analysis, try the
                <strong>"Balanced Growth"</strong> preset configuration
              </li>
              <li>
                Hover over <i class="fas fa-info-circle info-tooltip"></i> icons
                for detailed help
              </li>
              <li>Green highlighted values indicate recommended ranges</li>
            </ul>
          </div>
          <div class="col-md-4">
            <h6>Preset Configurations:</h6>
            <div
              class="preset-config"
              onclick="loadPreset('balanced')"
              id="preset-balanced"
            >
              <i class="fas fa-balance-scale"></i> Balanced Growth
            </div>
            <div
              class="preset-config"
              onclick="loadPreset('aggressive')"
              id="preset-aggressive"
            >
              <i class="fas fa-rocket"></i> Aggressive Growth
            </div>
            <div
              class="preset-config"
              onclick="loadPreset('conservative')"
              id="preset-conservative"
            >
              <i class="fas fa-shield-alt"></i> Conservative
            </div>
          </div>
        </div>
      </div>

      <!-- Required Fields Legend -->
      <div class="required-legend">
        <i class="fas fa-exclamation-circle"></i> <strong>Note:</strong> Fields
        marked with <span style="color: #dc3545">*</span> are required for the
        analysis to run successfully.
      </div>

      <!-- Validation Summary (Hidden by default) -->
      <div
        class="validation-summary"
        id="validationSummary"
        style="display: none"
      >
        <h6>
          <i class="fas fa-exclamation-triangle"></i> Please correct the
          following errors:
        </h6>
        <ul id="validationErrors"></ul>
      </div>

      <!-- Control Panel -->
      <div class="card">
        <div class="card-body">
          <h3>Analysis Control Panel</h3>

          <!-- Progress Bar -->
          <div class="form-progress">
            <div
              class="form-progress-bar"
              id="formProgress"
              style="width: 0%"
            ></div>
          </div>

          <!-- Input Parameters Section -->
          <div class="accordion mb-3" id="parametersAccordion">
            <!-- Economic Targets -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#economicTargets"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Economic Targets</span>
                    <span
                      class="badge bg-secondary section-status me-2"
                      id="economicTargetsStatus"
                      >Not Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="economicTargets"
                class="accordion-collapse collapse show"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="row">
                    <div class="col-md-4">
                      <label for="gdpTarget" class="form-label required"
                        >GDP Growth Target
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Total economic output growth target in billions of dollars"
                        ></i>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input
                          type="number"
                          class="form-control"
                          id="gdpTarget"
                          value="2.87"
                          step="0.1"
                          min="0"
                          required
                        />
                        <span class="input-group-text">Billion</span>
                      </div>
                      <div class="field-help">
                        Recommended: $1-5 billion for regional MSA
                      </div>
                      <span class="recommended-range">KC Target: $2.87B</span>
                    </div>
                    <div class="col-md-4">
                      <label for="directJobsTarget" class="form-label required"
                        >Direct Jobs Target
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Number of jobs directly created in the cluster businesses"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="directJobsTarget"
                        value="1000"
                        step="100"
                        min="0"
                        required
                      />
                      <div class="field-help">
                        Jobs directly created by cluster businesses
                      </div>
                      <span class="recommended-range">500-3000 jobs</span>
                    </div>
                    <div class="col-md-4">
                      <label for="indirectJobsTarget" class="form-label"
                        >Indirect Jobs Target
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Jobs created in supporting industries and services"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="indirectJobsTarget"
                        value="2000"
                        step="100"
                        min="0"
                      />
                      <div class="field-help">Typically 1.5-3x direct jobs</div>
                      <span class="recommended-range">1000-6000 jobs</span>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label for="wageGrowthTarget" class="form-label"
                        >Wage Growth Target (%)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="wageGrowthTarget"
                        value="8"
                        step="1"
                        min="0"
                        max="50"
                      />
                    </div>
                    <div class="col-md-4">
                      <label for="timeHorizon" class="form-label"
                        >Time Horizon</label
                      >
                      <select class="form-select" id="timeHorizon">
                        <option value="1">1 Year</option>
                        <option value="3" selected>3 Years</option>
                        <option value="5">5 Years</option>
                        <option value="10">10 Years</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="minROI" class="form-label"
                        >Minimum ROI (%)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="minROI"
                        value="15"
                        step="1"
                        min="0"
                        max="100"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Industry Focus (DEPRECATED - Now using Strategic Cluster Selection) -->
            <!-- Commenting out to avoid confusion with the new Strategic Cluster Selection section
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#industryFocus">
                                <span class="d-flex justify-content-between align-items-center w-100">
                                    <span>Industry & Cluster Focus</span>
                                    <span class="badge bg-secondary section-status me-2" id="industryFocusStatus">Not Ready</span>
                                </span>
                            </button>
                        </h2>
                        <div id="industryFocus" class="accordion-collapse collapse" data-bs-parent="#parametersAccordion">
                            <div class="accordion-body">
                                <div class="alert alert-warning mb-3">
                                    <i class="fas fa-exclamation-triangle"></i> <strong>Required:</strong> Select at least one industry cluster to focus the analysis.
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <label class="form-label required">Target Clusters
                                            <i class="fas fa-info-circle info-tooltip" data-bs-toggle="tooltip" title="Select the industry clusters you want to analyze for economic development"></i>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input cluster-type" type="checkbox" value="logistics" id="clusterLogistics" checked>
                                            <label class="form-check-label" for="clusterLogistics">
                                                Logistics & Distribution
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input cluster-type" type="checkbox" value="biosciences" id="clusterBio" checked>
                                            <label class="form-check-label" for="clusterBio">
                                                Biosciences & Pharmaceuticals
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input cluster-type" type="checkbox" value="technology" id="clusterTech" checked>
                                            <label class="form-check-label" for="clusterTech">
                                                Technology & Information
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input cluster-type" type="checkbox" value="manufacturing" id="clusterManufacturing" checked>
                                            <label class="form-check-label" for="clusterManufacturing">
                                                Advanced Manufacturing
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input cluster-type" type="checkbox" value="animal_health" id="clusterAnimal" checked>
                                            <label class="form-check-label" for="clusterAnimal">
                                                Animal Health
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    -->

            <!-- Geographic Scope -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#geographicScope"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Geographic Scope</span>
                    <span
                      class="badge bg-secondary section-status me-2"
                      id="geographicScopeStatus"
                      >Not Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="geographicScope"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Required:</strong> Select at least one county to
                    define the geographic area for analysis.
                  </div>

                  <!-- Focus Mode Indicator -->
                  <div class="focus-mode-indicator" id="focusModeIndicator">
                    <i class="fas fa-info-circle"></i>
                    <span id="focusModeText"></span>
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label required"
                        >Kansas Counties
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Select counties in Kansas to include in the cluster analysis"
                        ></i>
                      </label>

                      <div class="county-item" data-county-type="urban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-ks"
                            type="checkbox"
                            value="Johnson County, KS"
                            id="countyJohnsonKS"
                            checked
                          />
                          <label class="form-check-label" for="countyJohnsonKS">
                            Johnson County
                            <span class="county-type-badge county-type-urban"
                              >Urban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="urban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-ks"
                            type="checkbox"
                            value="Wyandotte County, KS"
                            id="countyWyandotteKS"
                            checked
                          />
                          <label
                            class="form-check-label"
                            for="countyWyandotteKS"
                          >
                            Wyandotte County
                            <span class="county-type-badge county-type-urban"
                              >Urban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="suburban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-ks"
                            type="checkbox"
                            value="Leavenworth County, KS"
                            id="countyLeavenworthKS"
                            checked
                          />
                          <label
                            class="form-check-label"
                            for="countyLeavenworthKS"
                          >
                            Leavenworth County
                            <span class="county-type-badge county-type-suburban"
                              >Suburban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="suburban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-ks"
                            type="checkbox"
                            value="Miami County, KS"
                            id="countyMiamiKS"
                            checked
                          />
                          <label class="form-check-label" for="countyMiamiKS">
                            Miami County
                            <span class="county-type-badge county-type-suburban"
                              >Suburban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="rural">
                        <div class="form-check">
                          <input
                            class="form-check-input county-ks"
                            type="checkbox"
                            value="Linn County, KS"
                            id="countyLinnKS"
                            checked
                          />
                          <label class="form-check-label" for="countyLinnKS">
                            Linn County
                            <span class="county-type-badge county-type-rural"
                              >Rural</span
                            >
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Missouri Counties</label>

                      <div class="county-item" data-county-type="urban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-mo"
                            type="checkbox"
                            value="Jackson County, MO"
                            id="countyJacksonMO"
                            checked
                          />
                          <label class="form-check-label" for="countyJacksonMO">
                            Jackson County
                            <span class="county-type-badge county-type-urban"
                              >Urban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="urban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-mo"
                            type="checkbox"
                            value="Clay County, MO"
                            id="countyClayMO"
                            checked
                          />
                          <label class="form-check-label" for="countyClayMO">
                            Clay County
                            <span class="county-type-badge county-type-urban"
                              >Urban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="suburban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-mo"
                            type="checkbox"
                            value="Platte County, MO"
                            id="countyPlatteMO"
                            checked
                          />
                          <label class="form-check-label" for="countyPlatteMO">
                            Platte County
                            <span class="county-type-badge county-type-suburban"
                              >Suburban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="suburban">
                        <div class="form-check">
                          <input
                            class="form-check-input county-mo"
                            type="checkbox"
                            value="Cass County, MO"
                            id="countyCassMO"
                            checked
                          />
                          <label class="form-check-label" for="countyCassMO">
                            Cass County
                            <span class="county-type-badge county-type-suburban"
                              >Suburban</span
                            >
                          </label>
                        </div>
                      </div>

                      <div class="county-item" data-county-type="rural">
                        <div class="form-check">
                          <input
                            class="form-check-input county-mo"
                            type="checkbox"
                            value="Ray County, MO"
                            id="countyRayMO"
                            checked
                          />
                          <label class="form-check-label" for="countyRayMO">
                            Ray County
                            <span class="county-type-badge county-type-rural"
                              >Rural</span
                            >
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-12">
                      <label class="form-label">Geographic Focus</label>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="geoFocus"
                          id="focusAll"
                          value="all"
                          checked
                        />
                        <label class="form-check-label" for="focusAll"
                          >All Areas</label
                        >
                      </div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="geoFocus"
                          id="focusUrban"
                          value="urban"
                        />
                        <label class="form-check-label" for="focusUrban"
                          >Urban Core</label
                        >
                      </div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="geoFocus"
                          id="focusSuburban"
                          value="suburban"
                        />
                        <label class="form-check-label" for="focusSuburban"
                          >Suburban</label
                        >
                      </div>
                    </div>
                    <div class="form-text text-muted mt-2">
                      <i class="fas fa-info-circle"></i>
                      <span id="geoFocusHelp">
                        All Areas: Includes all businesses in selected counties
                      </span>
                    </div>
                    <div class="alert alert-warning mt-2" id="geoFocusWarning" style="display: none;">
                      <i class="fas fa-exclamation-triangle"></i>
                      <span id="geoFocusWarningText"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Business Filtering -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#businessFilters"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Existing KC Businesses</span>
                    <span
                      class="badge bg-success section-status me-2"
                      id="businessFiltersStatus"
                      >Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="businessFilters"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="alert alert-info mb-3">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Important:</strong> We analyze ~50,000 existing KC-area businesses.
                    These filters determine which ones qualify for cluster analysis.
                    Setting filters too restrictive may exclude viable businesses.
                  </div>
                  <div class="row">
                    <div class="col-md-4">
                      <label for="minEmployees" class="form-label"
                        >Minimum Current Employees
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Only analyze existing businesses that currently have at least this many employees"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="minEmployees"
                        value="5"
                        min="1"
                        step="5"
                      />
                      <div class="field-help">
                        Small businesses typically have 5+ employees
                      </div>
                      <span class="recommended-range">5-20</span>
                    </div>
                    <div class="col-md-4">
                      <label for="maxEmployees" class="form-label"
                        >Maximum Employees
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Maximum number of employees (helps focus on specific business sizes)"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="maxEmployees"
                        value="10000"
                        min="1"
                        step="100"
                      />
                      <div class="field-help">
                        10,000 excludes only mega-corporations
                      </div>
                      <span class="recommended-range">1000-10000</span>
                    </div>
                    <div class="col-md-4">
                      <label for="businessAge" class="form-label"
                        >Minimum Business Age (Years)
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="How long the business has been operating (helps ensure stability)"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="businessAge"
                        value="2"
                        min="0"
                        step="1"
                      />
                      <div class="field-help">
                        2+ years shows some stability
                      </div>
                      <span class="recommended-range">1-5 years</span>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label for="minRevenue" class="form-label"
                        >Minimum Current Annual Revenue
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Only analyze businesses currently generating at least this much annual revenue (in millions)"
                        ></i>
                      </label>
                      <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input
                          type="number"
                          class="form-control"
                          id="minRevenue"
                          value="0.1"
                          step="0.1"
                          min="0"
                        />
                        <span class="input-group-text">Million</span>
                      </div>
                      <div class="field-help">
                        $100K minimum captures small businesses
                      </div>
                      <span class="recommended-range">$0.1-1M</span>
                    </div>
                    <div class="col-md-6">
                      <label for="minGrowthRate" class="form-label"
                        >Minimum Growth Rate (%)
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Minimum annual growth rate (optional filter)"
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="minGrowthRate"
                        value="0"
                        step="1"
                        min="-50"
                        max="200"
                      />
                      <div class="field-help">
                        0% includes stable businesses
                      </div>
                      <span class="recommended-range">0-10%</span>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-12">
                      <label class="form-label"
                        >Additional Filters
                        <i
                          class="fas fa-exclamation-triangle text-warning ms-2"
                          data-bs-toggle="tooltip"
                          title="Warning: These filters are very restrictive and may eliminate most businesses"
                        ></i>
                      </label>

                      <div
                        class="alert alert-warning py-2 px-3 mb-2"
                        style="font-size: 0.875rem"
                      >
                        <i class="fas fa-filter"></i>
                        <strong>Caution:</strong> Each filter will EXCLUDE all
                        businesses that don't meet the criteria
                      </div>

                      <div
                        id="additionalFilterWarning"
                        class="alert alert-danger py-2 px-3 mb-2"
                        style="display: none; font-size: 0.875rem"
                      >
                        <!-- Dynamic warning content will be inserted here -->
                      </div>

                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input additional-filter"
                          type="checkbox"
                          id="filterPatents"
                          data-filter-type="patents"
                        />
                        <label class="form-check-label" for="filterPatents">
                          Has Patents
                          <i
                            class="fas fa-info-circle text-muted"
                            data-bs-toggle="tooltip"
                            title="Only includes businesses with patent applications (typically <5% of businesses)"
                          ></i>
                        </label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input additional-filter"
                          type="checkbox"
                          id="filterSBIR"
                          data-filter-type="sbir"
                        />
                        <label class="form-check-label" for="filterSBIR">
                          SBIR/STTR Awards
                          <i
                            class="fas fa-info-circle text-muted"
                            data-bs-toggle="tooltip"
                            title="Only includes businesses with federal research grants (very rare)"
                          ></i>
                        </label>
                      </div>

                      <div class="mt-2">
                        <small
                          class="text-danger"
                          id="additionalFilterWarning"
                          style="display: none"
                        >
                          <i class="fas fa-exclamation-circle"></i>
                          <span id="filterWarningText"></span>
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Scoring Weights -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#scoringWeights"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>How to Score Existing Businesses & Clusters</span>
                    <span
                      class="badge bg-secondary section-status me-2"
                      id="scoringWeightsStatus"
                      >Not Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="scoringWeights"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="alert alert-info mb-3">
                    <i class="fas fa-balance-scale"></i>
                    <strong>How We Evaluate Existing Businesses:</strong><br />
                    • <strong>Business weights</strong> score each existing KC business
                    based on their innovation, market potential, and competitive position<br />
                    • <strong>Cluster weights</strong> evaluate groups of similar businesses
                    for their potential as economic development targets<br />
                    • <strong>Cluster weights</strong> determine how groups of
                    businesses are evaluated as economic clusters<br />
                    • Both sets must sum to 100% - adjust sliders to emphasize
                    what matters most for your analysis
                  </div>
                  <h6>
                    Business Scoring Weights
                    <span class="required-field"></span>
                  </h6>
                  <div class="row">
                    <div class="col-md-4">
                      <label for="innovationWeight" class="form-label">
                        Innovation Weight:
                        <span class="weight-value" id="innovationWeightValue"
                          >30%</span
                        >
                      </label>
                      <input
                        type="range"
                        class="form-range weight-slider"
                        id="innovationWeight"
                        min="0"
                        max="100"
                        value="30"
                        step="5"
                      />
                    </div>
                    <div class="col-md-4">
                      <label for="marketWeight" class="form-label">
                        Market Potential:
                        <span class="weight-value" id="marketWeightValue"
                          >40%</span
                        >
                      </label>
                      <input
                        type="range"
                        class="form-range weight-slider"
                        id="marketWeight"
                        min="0"
                        max="100"
                        value="40"
                        step="5"
                      />
                    </div>
                    <div class="col-md-4">
                      <label for="competitionWeight" class="form-label">
                        Competition:
                        <span class="weight-value" id="competitionWeightValue"
                          >30%</span
                        >
                      </label>
                      <input
                        type="range"
                        class="form-range weight-slider"
                        id="competitionWeight"
                        min="0"
                        max="100"
                        value="30"
                        step="5"
                      />
                    </div>
                  </div>
                  <div class="mt-2">
                    <small class="text-muted"
                      >Total: <span id="weightTotal">100%</span> (must equal
                      100%)</small
                    >
                  </div>
                  <hr />
                  <h6 class="mt-3">
                    Cluster Scoring Weights <span class="required-field"></span>
                  </h6>
                  <div class="row mt-3">
                    <div class="col-md-12">
                      <small class="text-muted"
                        >Total: <span id="clusterWeightTotal">100%</span> (must
                        equal 100%)</small
                      >
                    </div>
                    <div class="col-md-3">
                      <label for="naturalAssetsWeight" class="form-label"
                        >Natural Assets:
                        <span id="naturalAssetsValue">20%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="naturalAssetsWeight"
                        min="0"
                        max="50"
                        value="20"
                        step="5"
                      />
                    </div>
                    <div class="col-md-3">
                      <label for="infrastructureWeight" class="form-label"
                        >Infrastructure:
                        <span id="infrastructureValue">20%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="infrastructureWeight"
                        min="0"
                        max="50"
                        value="20"
                        step="5"
                      />
                    </div>
                    <div class="col-md-3">
                      <label for="workforceWeight" class="form-label"
                        >Workforce: <span id="workforceValue">15%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="workforceWeight"
                        min="0"
                        max="50"
                        value="15"
                        step="5"
                      />
                    </div>
                    <div class="col-md-3">
                      <label for="marketAccessWeight" class="form-label"
                        >Market Access:
                        <span id="marketAccessValue">15%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="marketAccessWeight"
                        min="0"
                        max="50"
                        value="15"
                        step="5"
                      />
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-3">
                      <label for="innovationClusterWeight" class="form-label"
                        >Innovation:
                        <span id="innovationClusterValue">15%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="innovationClusterWeight"
                        min="0"
                        max="50"
                        value="15"
                        step="5"
                      />
                    </div>
                    <div class="col-md-3">
                      <label for="geopoliticalWeight" class="form-label"
                        >Geopolitical:
                        <span id="geopoliticalValue">10%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="geopoliticalWeight"
                        min="0"
                        max="50"
                        value="10"
                        step="5"
                      />
                    </div>
                    <div class="col-md-3">
                      <label for="resilienceWeight" class="form-label"
                        >Resilience: <span id="resilienceValue">5%</span></label
                      >
                      <input
                        type="range"
                        class="form-range"
                        id="resilienceWeight"
                        min="0"
                        max="50"
                        value="5"
                        step="5"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Data Sources -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#dataSources"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Data Sources & Quality</span>
                    <span
                      class="badge bg-success section-status me-2"
                      id="dataSourcesStatus"
                      >Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="dataSources"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Required:</strong> Select at least one data source
                    for the analysis.
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <label class="form-label required"
                        >Data Sources to Include
                        <i
                          class="fas fa-info-circle info-tooltip"
                          data-bs-toggle="tooltip"
                          title="Select which data sources to use for gathering business and economic information"
                        ></i>
                      </label>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="sourceStateRegistries"
                          checked
                        />
                        <label
                          class="form-check-label"
                          for="sourceStateRegistries"
                        >
                          State Business Registries (KS & MO Secretary of State)
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="sourceBLS"
                          checked
                        />
                        <label class="form-check-label" for="sourceBLS">
                          Bureau of Labor Statistics (Employment & Wages)
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="sourceUSPTO"
                          checked
                        />
                        <label class="form-check-label" for="sourceUSPTO">
                          USPTO Patent Database
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="sourceSBIR"
                          checked
                        />
                        <label class="form-check-label" for="sourceSBIR">
                          SBIR/STTR Awards Database
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="sourceEDCKC"
                        />
                        <label class="form-check-label" for="sourceEDCKC">
                          Economic Development Corporation of KC
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Infrastructure Requirements -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#infrastructure"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Infrastructure & Resource Requirements</span>
                    <span
                      class="badge bg-success section-status me-2"
                      id="infrastructureStatus"
                      >Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="infrastructure"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div
                    class="alert alert-info mb-3"
                    style="font-size: 0.875rem"
                  >
                    <i class="fas fa-info-circle"></i>
                    <strong>How Infrastructure Requirements Work:</strong><br />
                    These preferences filter clusters based on their
                    infrastructure scores. Each cluster type has different
                    thresholds:<br />
                    • <strong>Logistics clusters</strong> need rail access
                    (score ≥ 80)<br />
                    • <strong>Technology clusters</strong> need broadband (score
                    ≥ 70) and STEM workforce<br />
                    • <strong>Biosciences clusters</strong> need university
                    partnerships (score ≥ 65)<br />
                    • <strong>Manufacturing clusters</strong> need utilities
                    infrastructure (score ≥ 75)<br />
                    <small class="text-muted"
                      >âš ï¸ Note: Too many requirements may filter out viable
                      clusters.</small
                    >
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <label class="form-label"
                        >Infrastructure Preferences
                        <i
                          class="fas fa-question-circle text-muted ms-2"
                          data-bs-toggle="tooltip"
                          title="Select infrastructure features that would benefit your target clusters"
                        ></i>
                      </label>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireRail"
                          data-cluster-types="logistics,manufacturing"
                        />
                        <label class="form-check-label" for="requireRail">
                          Rail Access
                          <small class="text-muted d-block"
                            >Essential for logistics & manufacturing
                            clusters</small
                          >
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireHighway"
                          data-cluster-types="logistics,manufacturing"
                        />
                        <label class="form-check-label" for="requireHighway">
                          Major Highway Access (I-35/I-70)
                          <small class="text-muted d-block"
                            >Critical for distribution & supply chain</small
                          >
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireAirport"
                          data-cluster-types="technology,biosciences"
                        />
                        <label class="form-check-label" for="requireAirport">
                          Airport Proximity (&lt;30 miles)
                          <small class="text-muted d-block"
                            >Important for tech & biotech talent/clients</small
                          >
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireBroadband"
                          data-cluster-types="technology,services"
                        />
                        <label class="form-check-label" for="requireBroadband">
                          High-Speed Broadband (&gt;1 Gbps)
                          <small class="text-muted d-block"
                            >Essential for tech & digital services</small
                          >
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label"
                        >Workforce Preferences
                        <i
                          class="fas fa-question-circle text-muted ms-2"
                          data-bs-toggle="tooltip"
                          title="Select workforce characteristics that support your target clusters"
                        ></i>
                      </label>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireSTEM"
                          data-cluster-types="technology,biosciences"
                        />
                        <label class="form-check-label" for="requireSTEM">
                          STEM Workforce Concentration
                          <small class="text-muted d-block"
                            >Critical for tech & R&D-intensive clusters</small
                          >
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireUniversity"
                          data-cluster-types="technology,biosciences"
                        />
                        <label class="form-check-label" for="requireUniversity">
                          University Partnership Potential
                          <small class="text-muted d-block"
                            >Enables research collaboration & talent
                            pipeline</small
                          >
                        </label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input infrastructure-pref"
                          type="checkbox"
                          id="requireSkilled"
                          data-cluster-types="manufacturing,logistics"
                        />
                        <label class="form-check-label" for="requireSkilled">
                          Skilled Trade Workforce
                          <small class="text-muted d-block"
                            >Essential for manufacturing & logistics
                            operations</small
                          >
                        </label>
                      </div>
                    </div>
                  </div>

                  <div
                    id="infrastructureImpact"
                    class="alert alert-secondary mt-3"
                    style="display: none; font-size: 0.875rem"
                  >
                    <i class="fas fa-chart-bar"></i>
                    <strong>Scoring Impact:</strong>
                    <span id="infrastructureImpactText"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Strategic Cluster Selection -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#algorithmParams"
                >
                  <span
                    class="d-flex justify-content-between align-items-center w-100"
                  >
                    <span>Automatic Cluster Discovery</span>
                    <span
                      class="badge bg-success section-status me-2"
                      id="algorithmParamsStatus"
                      >Ready</span
                    >
                  </span>
                </button>
              </h2>
              <div
                id="algorithmParams"
                class="accordion-collapse collapse"
                data-bs-parent="#parametersAccordion"
              >
                <div class="accordion-body">
                  <div class="alert alert-info mb-4">
                    <i class="fas fa-robot"></i> <strong>Fully Automatic Discovery System</strong>
                    <p class="mb-2 mt-2">The AI-powered system automatically determines:</p>
                    <ul class="mb-0">
                      <li><strong>Optimal number of clusters:</strong> Tests 2-10 clusters using validation metrics</li>
                      <li><strong>Cluster sizes:</strong> Intelligently sized based on business availability</li>
                      <li><strong>Cluster types:</strong> Discovered from actual business compositions, not predetermined</li>
                    </ul>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="alert alert-success">
                        <h6 class="alert-heading"><i class="fas fa-chart-line"></i> Statistical Validation</h6>
                        <ul class="mb-0 small">
                          <li><strong>Silhouette Score:</strong> Measures cluster separation quality</li>
                          <li><strong>Davies-Bouldin Index:</strong> Evaluates cluster compactness</li>
                          <li><strong>Calinski-Harabasz Score:</strong> Assesses cluster density</li>
                        </ul>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="fas fa-bullseye"></i> Economic Targeting</h6>
                        <p class="mb-0 small">The system selects cluster configurations that best meet your specified GDP and job creation targets through multi-objective optimization.</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Hidden inputs for backward compatibility -->
                  <input type="hidden" id="numClusters" value="0" />
                  <input type="hidden" id="clusterSizeMin" value="0" />
                  <input type="hidden" id="clusterSizeMax" value="0" />

                  <!-- Business quality threshold removed - backend handles automatically -->

                  <div class="row mt-4">
                    <div class="col-md-6">
                      <label for="optimizationFocus" class="form-label"
                        >Optimization Focus
                        <i
                          class="fas fa-question-circle text-muted ms-2"
                          data-bs-toggle="tooltip"
                          title="Choose what to prioritize when ranking clusters"
                        ></i>
                      </label>
                      <select class="form-select" id="optimizationFocus">
                        <option value="balanced" selected>
                          Balanced Growth
                        </option>
                        <option value="gdp">Maximize GDP Impact</option>
                        <option value="jobs">Maximize Job Creation</option>
                        <option value="innovation">Maximize Innovation</option>
                      </select>
                      <div class="field-help">
                        <small class="text-muted">
                          <span id="optimizationExplanation"
                            >Balanced approach considers GDP, jobs, and
                            innovation equally</span
                          >
                        </small>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label for="mlEnhancement" class="form-label"
                        >Machine Learning Enhancement
                        <i
                          class="fas fa-question-circle text-muted ms-2"
                          data-bs-toggle="tooltip"
                          title="Use ML models to predict cluster performance based on historical data"
                        ></i>
                      </label>
                      <select class="form-select" id="mlEnhancement">
                        <option value="enhanced" selected>
                          Enhanced with KC Data (Best Accuracy)
                        </option>
                        <option value="true">
                          Standard ML Enhancement
                        </option>
                        <option value="false">Disabled</option>
                      </select>
                      <div class="field-help">
                        <small class="text-muted">
                          Enhanced mode uses 18-feature models with KC Open Data for 1.2% better ROI predictions
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <button
                id="runAnalysis"
                class="btn btn-secondary btn-lg w-100"
                onclick="runAnalysis()"
                disabled
              >
                <i class="fas fa-exclamation-circle"></i> Complete All Sections
                First
              </button>
            </div>
            <div class="col-md-6">
              <div class="btn-group w-100" role="group">
                <button
                  class="btn btn-outline-secondary"
                  onclick="exportResults('json')"
                >
                  Export JSON
                </button>
                <button
                  class="btn btn-outline-secondary"
                  onclick="exportResults('csv')"
                >
                  Export CSV
                </button>
                <button
                  class="btn btn-outline-secondary"
                  onclick="exportResults('pdf')"
                >
                  Export PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div id="metricsSection" style="display: none">
        <div class="row">
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="gdpImpact">$0</div>
              <div class="metric-label">GDP Impact</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="totalJobs">0</div>
              <div class="metric-label">Total Jobs</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="clustersFound">0</div>
              <div class="metric-label">Clusters Identified</div>
            </div>
          </div>
          <!-- Target Status tile (restored) -->
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value">
                <span id="targetStatusBadge" class="status-badge">—</span>
              </div>
              <div class="metric-label">Target Status</div>
            </div>
          </div>
        </div>
        
        <!-- Additional metrics row -->
        <div class="row mt-3">
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="wageGrowth">-</div>
              <div class="metric-label">Wage Growth</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="projectedROI">-</div>
              <div class="metric-label">Return on Investment</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="investmentRequired">-</div>
              <div class="metric-label">Investment Required</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="metric-value" id="analysisMode">-</div>
              <div class="metric-label">Analysis Mode</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Visualizations -->
      <div id="visualizationsSection" style="display: none">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div id="gdpChart"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div id="jobsChart"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div id="spiderChart"></div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div id="businessPie"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div id="gaugeChart"></div>
          </div>
        </div>
      </div>

      <!-- Natural Communities Section -->
      <div id="naturalCommunitiesSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Natural Business Communities Discovered</h3>
            <p class="text-muted mb-3">These organic business groupings were identified based on geographic proximity, industry relationships, and business size similarities.</p>
            <div id="naturalCommunitiesList"></div>
          </div>
        </div>
      </div>

      <!-- Cluster Details Section -->
      <div id="clusterDetailsSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Top Performing Clusters</h3>
            <div id="clusterDetailsList"></div>
          </div>
        </div>
      </div>

      <!-- ML Insights Section -->
      <div id="mlInsightsSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Machine Learning Insights</h3>
            
            <!-- ML Predictions Comparison -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>Strategic vs ML-Enhanced Predictions</h5>
                <div id="mlPredictionsChart"></div>
              </div>
            </div>
            
            <!-- Confidence Scores -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>Prediction Confidence Analysis</h5>
                <div id="confidenceChart"></div>
              </div>
            </div>
            
            <!-- Business Network Graph -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>Business Network Relationships</h5>
                <div id="networkGraph"></div>
              </div>
            </div>
            
            <!-- Feature Importance -->
            <div class="row mt-4">
              <div class="col-md-6">
                <h5>ML Model Feature Importance</h5>
                <div id="featureImportanceChart"></div>
              </div>
              <div class="col-md-6">
                <h5>Prediction Intervals</h5>
                <div id="predictionIntervalsChart"></div>
              </div>
            </div>
            
            <!-- Cluster Synergies -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>Inter-Cluster Synergy Analysis</h5>
                <div id="synergyHeatmap"></div>
                <div id="synergyRecommendations" class="mt-3"></div>
              </div>
            </div>
            
            <!-- ML Explanations -->
            <div class="row mt-4">
              <div class="col-12">
                <h5>ML Model Explanations</h5>
                <div id="mlInsightsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Market Monitoring Section -->
      <div id="marketMonitoringSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Market Conditions Analysis</h3>
            <div class="row">
              <div class="col-md-6">
                <h5>Economic Indicators</h5>
                <div id="economicIndicatorsList"></div>
              </div>
              <div class="col-md-6">
                <h5>Commodity Prices</h5>
                <div id="commodityPricesList"></div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <h5>Market Favorability by Cluster</h5>
                <div id="marketScoresList"></div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <h5>Market Insights</h5>
                <div id="marketInsightsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommendations -->
      <div id="recommendationsSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Key Recommendations</h3>
            <div class="row mt-4">
              <div class="col-md-6">
                <h5>For Entrepreneurs</h5>
                <div id="entrepreneurRecs"></div>
              </div>
              <div class="col-md-6">
                <h5>For Investors</h5>
                <div id="investorRecs"></div>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-md-6">
                <h5>For Universities</h5>
                <div id="universityRecs"></div>
              </div>
              <div class="col-md-6">
                <h5>For Policymakers</h5>
                <div id="policyRecs"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Section -->
      <div id="reportSection" style="display: none">
        <div class="card">
          <div class="card-body">
            <h3>Full Analysis Report</h3>
            <pre
              id="reportContent"
              style="white-space: pre-wrap; font-family: sans-serif"
            ></pre>
          </div>
        </div>
      </div>

      

      <!-- Map Visualization Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h5>Geographic Visualization</h5>
        </div>
        <div class="card-body">
          <div class="btn-group" role="group">
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="showClusterMap()"
            >
              <i class="fas fa-map-marked-alt"></i> Cluster Map
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="showGrowthPotentialMap()"
            >
              <i class="fas fa-chart-line"></i> Growth Potential
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="showEconomicImpactMap()"
            >
              <i class="fas fa-dollar-sign"></i> Economic Impact
            </button>
          </div>
          <div
            id="mapContainer"
            class="mt-3"
            style="display: none;"
          >
            <!-- Map will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Scenario Comparison Section -->
      <div class="card mt-4">
        <div class="card-header">
          <h5>Scenario Comparison</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <button
                type="button"
                class="btn btn-success"
                onclick="saveCurrentScenario()"
              >
                <i class="fas fa-save"></i> Save Current Scenario
              </button>
              <button
                type="button"
                class="btn btn-info"
                onclick="loadScenarios()"
              >
                <i class="fas fa-list"></i> View Saved Scenarios
              </button>
            </div>
            <div class="col-md-6">
              <button
                type="button"
                class="btn btn-warning"
                onclick="compareScenarios()"
              >
                <i class="fas fa-chart-bar"></i> Compare Scenarios
              </button>
            </div>
          </div>

          <!-- Scenario List -->
          <div id="scenarioList" class="mt-3" style="display: none">
            <h6>Saved Scenarios</h6>
            <div class="list-group" id="scenarioListContent">
              <!-- Scenarios will be loaded here -->
            </div>
          </div>

          <!-- Comparison Results -->
          <div id="comparisonResults" class="mt-3" style="display: none">
            <!-- Comparison charts will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
      <div class="text-center">
        <div class="spinner"></div>
        <p class="text-white mt-3">
          Running analysis... This may take a few moments.
        </p>
      </div>
    </div>

    <!-- Clear Filters Button (appears when filters are too restrictive) -->
    <button
      id="clearFiltersBtn"
      class="btn btn-warning clear-filters-btn"
      onclick="clearProblematicFilters()"
    >
      <i class="fas fa-eraser"></i> Clear Problematic Filters
    </button>

    <script src="/static/js/analysis-mode.js?v=3"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script nonce="{{ session.get('csrf_token') }}">
      let currentAnalysisId = null;
      let lastKnownProgress = 0; // monotonic progress across socket + polling

      // Initialize on page load
      $(document).ready(function () {
        console.log("Document ready - initializing form validation...");

        // Initialize WebSocket connection
        const socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to WebSocket server');
        });
        
        socket.on('analysis_progress', function(data) {
            console.log('Progress update:', data);
            // Update progress modal if it exists
            if ($('#progressModal').length && data.task_id === currentAnalysisId) {
                // Update progress bar
                const progressBar = $('#analysisProgress');
                if (progressBar.length && typeof data.progress === 'number') {
                    const p = Math.max(lastKnownProgress, data.progress);
                    lastKnownProgress = p;
                    progressBar.css('width', p + '%');
                    progressBar.text(Math.round(p) + '%');
                    progressBar.attr('aria-valuenow', p);
                    // Update ETA from elapsed + progress
                    try {
                      const t0 = window._analysisStartTime || Date.now();
                      const elapsedSec = Math.floor((Date.now() - t0) / 1000);
                      if (p > 0 && elapsedSec >= 5) {
                        const remaining = Math.max(0, Math.round(elapsedSec * (100 / p - 1)));
                        const rm = Math.floor(remaining / 60);
                        const rs = remaining % 60;
                        $('#etaTime').text(`ETA ~ ${rm}:${rs.toString().padStart(2,'0')}`);
                      }
                    } catch (e) {}
                    // Parse batch metadata if present in message
                    if (typeof data.message === 'string') {
                      const m = data.message.match(/\[BATCH([^\]]+)\]/);
                      if (m) {
                        const parts = Object.fromEntries(m[1].trim().split(/\s+/).map(kv=>kv.split('=')));
                        if (parts.offset && parts.size && parts.cap) {
                          const idx = Math.floor(parseInt(parts.offset)/parseInt(parts.size)) + 1;
                          const total = Math.ceil(parseInt(parts.cap)/parseInt(parts.size));
                          $('#batchInfo').text(`Patent batches: ${idx} / ${total}`);
                        }
                      }
                    }
                }
                
                // Update status message
                const progressText = $('#progressStatus');
                if (progressText.length && data.message) {
                    progressText.text(data.message);
                }
                
                // Update stage
                const stageText = $('.stage-text');
                if (stageText.length && data.stage) {
                    stageText.text('Stage: ' + data.stage);
                }
                
                // Update highlights
                if (data.highlight) {
                    const highlightsList = $('#highlightsList');
                    if (highlightsList.length) {
                        // Clear initial waiting message if this is the first highlight
                        if (highlightsList.find('.text-muted').length > 0) {
                            highlightsList.empty();
                        }
                        // Add new highlight
                        highlightsList.append(`
                            <div class="mb-1">
                                <i class="fas fa-check-circle text-success"></i> ${data.highlight}
                            </div>
                        `);
                        // Auto-scroll to bottom
                        $('#progressHighlights').scrollTop($('#progressHighlights')[0].scrollHeight);
                    }
                }
            }
        });
        
        socket.on('analysis_error', function(data) {
            console.error('Analysis error:', data);
            if (data.task_id === currentAnalysisId) {
                hideLoading();
                alert('Analysis error: ' + data.error);
            }
        });

        // Wait for Bootstrap to initialize
        setTimeout(function () {
          console.log("Initializing form after Bootstrap load...");

          // Initialize tooltips
          $('[data-bs-toggle="tooltip"]').tooltip();

          // Initialize form progress tracking
          updateFormProgress();

          // Trigger form progress update after a short delay to ensure all values are loaded
          setTimeout(function () {
            console.log("Running initial form validation...");
            updateFormProgress();
            // Also trigger change events on sliders to update their displays
            $(".weight-slider, .cluster-weight-slider").trigger("input");
          }, 100);
        }, 50);

        // Additional delayed check to ensure everything is loaded
        setTimeout(function () {
          console.log("Running delayed form validation check...");
          updateFormProgress();

          // Log current state of all inputs
          console.log("Current form state:", {
            gdpTarget: $("#gdpTarget").val(),
            directJobsTarget: $("#directJobsTarget").val(),
            indirectJobsTarget: $("#indirectJobsTarget").val(),
            countiesChecked: $(".county-ks:checked, .county-mo:checked").length,
            businessFilters: {
              minEmployees: $("#minEmployees").val(),
              maxEmployees: $("#maxEmployees").val(),
              minRevenue: $("#minRevenue").val(),
              businessAge: $("#businessAge").val(),
            },
            businessWeights: {
              innovation: $("#innovationWeight").val(),
              market: $("#marketWeight").val(),
              competition: $("#competitionWeight").val(),
            },
            clusterWeights: {
              naturalAssets: $("#naturalAssetsWeight").val(),
              infrastructure: $("#infrastructureWeight").val(),
              workforce: $("#workforceWeight").val(),
              innovation: $("#innovationClusterWeight").val(),
              marketAccess: $("#marketAccessWeight").val(),
              geopolitical: $("#geopoliticalWeight").val(),
              resilience: $("#resilienceWeight").val(),
            },
            dataSources: $('input[id^="source"]:checked').length,
            numClusters: $("#numClusters").val(),
          });
        }, 500);

        // Update form progress when accordion sections are shown
        $(".accordion-button").on("click", function () {
          setTimeout(updateFormProgress, 50);
        });

        // Add change handlers for all form inputs to trigger validation
        $("#gdpTarget, #directJobsTarget, #indirectJobsTarget").on(
          "input change",
          function () {
            console.log(
              "Economic target changed:",
              $(this).attr("id"),
              "=",
              $(this).val()
            );
            updateFormProgress();
          }
        );

        $(".county-ks, .county-mo").on("change", function () {
          console.log("County selection changed");
          updateFormProgress();
        });

        $("#minEmployees, #maxEmployees, #minRevenue, #businessAge").on(
          "input change",
          function () {
            console.log(
              "Business filter changed:",
              $(this).attr("id"),
              "=",
              $(this).val()
            );
            updateFormProgress();
          }
        );

        $('input[id^="source"]').on("change", function () {
          console.log("Data source changed");
          updateFormProgress();
        });


        // Pareto threshold removed - backend optimization determines best threshold

        // Also add a manual override for testing
        window.forceEnableAnalysis = function () {
          $("#runAnalysis")
            .removeClass("btn-secondary")
            .addClass("btn-primary")
            .prop("disabled", false)
            .html('<i class="fas fa-play-circle"></i> Run Analysis');
          console.log("Analysis button manually enabled");
        };

        // Force validation after all DOM updates
        window.forceValidateAll = function () {
          console.log("Force validating all sections...");

          // Manually trigger all validations
          validateWeights();
          validateClusterWeights();

          // Force updateFormProgress with a delay
          setTimeout(function () {
            updateFormProgress();

            // If still having issues, manually set all sections to ready
            const sections = [
              "economicTargets",
              "geographicScope",
              "businessFilters",
              "scoringWeights",
              "dataSources",
              "algorithmParams",
              "infrastructure",
            ];

            sections.forEach((section) => {
              const badge = $(`#${section}Status`);
              if (badge.length > 0) {
                // Check if section should be ready based on current values
                let shouldBeReady = false;

                switch (section) {
                  case "economicTargets":
                    shouldBeReady =
                      $("#gdpTarget").val() &&
                      $("#directJobsTarget").val() &&
                      $("#indirectJobsTarget").val();
                    break;
                  case "geographicScope":
                    shouldBeReady =
                      $(".county-ks:checked, .county-mo:checked").length > 0;
                    break;
                  case "businessFilters":
                    shouldBeReady =
                      $("#minEmployees").val() &&
                      $("#maxEmployees").val() &&
                      $("#minRevenue").val() &&
                      $("#businessAge").val();
                    break;
                  case "scoringWeights":
                    const bTotal =
                      parseFloat($("#innovationWeight").val() || 0) +
                      parseFloat($("#marketWeight").val() || 0) +
                      parseFloat($("#competitionWeight").val() || 0);
                    const cTotal =
                      parseFloat($("#naturalAssetsWeight").val() || 0) +
                      parseFloat($("#infrastructureWeight").val() || 0) +
                      parseFloat($("#workforceWeight").val() || 0) +
                      parseFloat($("#innovationClusterWeight").val() || 0) +
                      parseFloat($("#marketAccessWeight").val() || 0) +
                      parseFloat($("#geopoliticalWeight").val() || 0) +
                      parseFloat($("#resilienceWeight").val() || 0);
                    shouldBeReady =
                      Math.abs(bTotal - 100) < 0.1 &&
                      Math.abs(cTotal - 100) < 0.1;
                    break;
                  case "dataSources":
                    shouldBeReady = $('input[id^="source"]:checked').length > 0;
                    break;
                  case "algorithmParams":
                    shouldBeReady = true; // Always ready - automatic discovery
                    break;
                  case "infrastructure":
                    shouldBeReady = true; // Always ready as it's optional
                    break;
                }

                console.log(
                  `Section ${section} should be ready: ${shouldBeReady}`
                );

                if (shouldBeReady && !badge.hasClass("bg-success")) {
                  badge
                    .removeClass("bg-secondary bg-danger")
                    .addClass("bg-success")
                    .text("Ready");
                }
              }
            });

            // Final update
            updateFormProgress();
          }, 100);
        };

        // Call force validation after a delay
        setTimeout(forceValidateAll, 1000);

        // All slider value updates
        // Pareto threshold slider removed - backend determines optimal threshold

        $("#confidenceThreshold").on("input", function () {
          $("#confidenceValue").text($(this).val() + "%");
        });

        // Cluster parameter change handlers
        $("#numClusters, #clusterSizeMin, #clusterSizeMax").on("change", function () {
          updateFormProgress();
        });

        // Weight sliders with validation
        $(".weight-slider").on("input", function () {
          updateWeightDisplay();
          validateWeights();
        });

        // Cluster weight sliders
        $(".cluster-weight-slider").on("input", function () {
          updateClusterWeightDisplay();
          validateClusterWeights();
        });

        $("#naturalAssetsWeight").on("input", function () {
          $("#naturalAssetsValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#infrastructureWeight").on("input", function () {
          $("#infrastructureValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#workforceWeight").on("input", function () {
          $("#workforceValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#marketAccessWeight").on("input", function () {
          $("#marketAccessValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#innovationClusterWeight").on("input", function () {
          $("#innovationClusterValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#geopoliticalWeight").on("input", function () {
          $("#geopoliticalValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });
        $("#resilienceWeight").on("input", function () {
          $("#resilienceValue").text($(this).val() + "%");
          validateClusterWeights();
          updateFormProgress();
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Track form completion
        $("input, select").on("change input", updateFormProgress);

        // Geographic focus changes
        $('input[name="geoFocus"]').on("change", handleGeographicFocusChange);

        // Additional filter warnings
        $(".additional-filter").on("change", handleAdditionalFilterChange);

        // Infrastructure preference handling
        $(".infrastructure-pref").on("change", handleInfrastructureChange);

        // Optimization focus changes
        $("#optimizationFocus").on("change", function () {
          const value = $(this).val();
          let explanation = "";
          switch (value) {
            case "balanced":
              explanation =
                "Balanced approach considers GDP, jobs, and innovation equally";
              break;
            case "gdp":
              explanation =
                "Prioritizes clusters that maximize total economic output and revenue generation";
              break;
            case "jobs":
              explanation =
                "Focuses on clusters that create the most direct and indirect employment opportunities";
              break;
            case "innovation":
              explanation =
                "Emphasizes clusters with high patent activity, R&D spending, and SBIR awards";
              break;
          }
          $("#optimizationExplanation").text(explanation);
        });

        // Load default preset
        loadPreset("balanced");

        // Initialize geographic focus (trigger change event on the default selection)
        $('input[name="geoFocus"]:checked').trigger("change");

        // Analysis Mode functionality
        $('input[name="analysisMode"]').on("change", function () {
          const isQuickMode = $("#quickMode").is(":checked");

          if (isQuickMode) {
            // Quick mode settings
            $("#mlEnhancement").val("enhanced"); // Prefer enhanced KC models
            $("#marketMonitoring").val("false");

            // Limit data sources
            $("#sourceUSPTO").prop("checked", false);
            $("#sourceSBIR").prop("checked", false);
            $("#sourceEDCKC").prop("checked", false);

            // Automatic discovery - no manual parameters needed

            // Update time estimate
            $("#estimatedTime")
              .text("~5 minutes")
              .removeClass("bg-warning")
              .addClass("bg-info");
            $("#modeInfo").html(
              "<small><strong>Quick Mode Active:</strong> Patents skipped, automatic discovery with ML intelligence</small>"
            );
          } else {
            // Full mode settings
            $("#mlEnhancement").val("enhanced");
            $("#marketMonitoring").val("true");

            // Enable all data sources
            $('input[id^="source"]').prop("checked", true);

            // Automatic discovery - no manual parameters needed

            // Update time estimate
            $("#estimatedTime")
              .text("~2-3 hours")
              .removeClass("bg-info")
              .addClass("bg-warning");
            $("#modeInfo").html(
              "<small><strong>Full Mode Active:</strong> All data sources, comprehensive discovery, patents included</small>"
            );
          }

          updateFormProgress();
          updateTimeEstimate();
        });

        // Add time estimation function
        function updateTimeEstimate() {
          const isQuickMode = $("#quickMode").is(":checked");
          let minutes = 5; // Base time

          // Counties
          const counties = $(".county-ks:checked, .county-mo:checked").length;
          minutes += counties * 2;

          // Patent search is the biggest factor (skip in quick mode)
          if (!isQuickMode && $("#sourceUSPTO").is(":checked")) {
            minutes += 120; // 2 hours
          }

          // ML and market monitoring
          if ($("#mlEnhancement").val() === "true") {
            minutes += 10;
          }
          if ($("#marketMonitoring").val() === "true") {
            minutes += 10;
          }

          // Data sources
          const dataSources = $('input[id^="source"]:checked').length;
          minutes += dataSources * 5;

          // Format time display
          let timeStr, badgeClass;
          if (minutes < 60) {
            timeStr = `~${Math.round(minutes)} minutes`;
            badgeClass = minutes < 15 ? "bg-success" : "bg-info";
          } else {
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            timeStr = `~${hours}h ${mins}m`;
            badgeClass = "bg-warning";
          }

          $("#estimatedTime")
            .text(timeStr)
            .removeClass("bg-success bg-info bg-warning")
            .addClass(badgeClass);
        }

        // Update time estimate when relevant parameters change
        $(
          '.county-ks, .county-mo, input[id^="source"], #mlEnhancement, #marketMonitoring'
        ).on("change", updateTimeEstimate);
      });

      // Add async progress monitoring function
        function monitorAsyncProgress(jobId) {
        // Reset monotonic tracker for a new run
        lastKnownProgress = 0;
        let lastProgress = 0;
        const progressModal = $(`
                <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-chart-line me-2"></i>Analysis in Progress
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="progress mb-3" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped bg-primary"
                                         role="progressbar" style="width: 0%; transition: width 0.5s ease;" id="analysisProgress">0%</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 id="progressStatus" class="mb-0 progress-text">Initializing analysis...</h6>
                                    <div class="text-muted">
                                      <small class="me-3"><i class="fas fa-clock"></i> <span id="elapsedTime">0:00</span></small>
                                      <small><i class="fas fa-hourglass-half"></i> <span id="etaTime">ETA ~ --:--</span></small>
                                    </div>
                                </div>
                                <div class="text-end mb-2">
                                  <small id="batchInfo" class="text-muted"></small>
                                </div>
                                <div class="text-center mb-2">
                                    <small class="stage-text text-info"></small>
                                </div>
                                
                                <!-- Highlights Section -->
                                <div id="progressHighlights" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                    <h6 class="text-muted mb-2"><i class="fas fa-tasks"></i> Progress Highlights</h6>
                                    <div id="highlightsList" class="small">
                                        <div class="text-muted">Waiting for analysis to begin...</div>
                                    </div>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <small class="text-muted">Job ID: ${jobId}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);

        $("body").append(progressModal);
        $("#progressModal").modal("show");

        // Track start time for elapsed time display
        const startTime = Date.now();
        window._analysisStartTime = startTime;
        
        // Update elapsed time every second
        const timeInterval = setInterval(function() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            $("#elapsedTime").text(`${minutes}:${seconds.toString().padStart(2, '0')}`);
        }, 1000);

        // Poll for status updates
        const checkInterval = setInterval(function () {
          $.get(`/api/analysis_status/${jobId}`)
            .done(function (status) {
              // Only update when server provides a numeric progress
              if (typeof status.progress === 'number') {
                const p = Math.max(lastProgress, status.progress);
                lastProgress = p;
                lastKnownProgress = Math.max(lastKnownProgress, p);
                // Update progress bar with smooth animation
                $("#analysisProgress")
                  .css("width", p + "%")
                  .text(p + "%")
                  .attr("aria-valuenow", p);
                // Update ETA
                try {
                  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
                  if (p > 0 && elapsedSec >= 5) {
                    const remaining = Math.max(0, Math.round(elapsedSec * (100 / p - 1)));
                    const rm = Math.floor(remaining / 60);
                    const rs = remaining % 60;
                    $('#etaTime').text(`ETA ~ ${rm}:${rs.toString().padStart(2,'0')}`);
                  }
                } catch (e) {}
              }
              // Update status message if provided
              if (status.message) {
                $("#progressStatus").text(status.message);
                // Parse batch metadata if embedded
                const m = status.message.match(/\[BATCH([^\]]+)\]/);
                if (m) {
                  const parts = Object.fromEntries(m[1].trim().split(/\s+/).map(kv=>kv.split('=')));
                  if (parts.offset && parts.size && parts.cap) {
                    const idx = Math.floor(parseInt(parts.offset)/parseInt(parts.size)) + 1;
                    const total = Math.ceil(parseInt(parts.cap)/parseInt(parts.size));
                    $('#batchInfo').text(`Patent batches: ${idx} / ${total}`);
                  } else if (parts.done || parts.complete) {
                    $('#batchInfo').text('Patent batches: complete');
                  }
                }
              }
              // Update stage label if provided
              if (status.stage) {
                $('.stage-text').text('Stage: ' + status.stage);
              }
              
              // Update highlights if available
              if (status.highlights && status.highlights.length > 0) {
                let highlightsHtml = '';
                status.highlights.forEach(function(highlight) {
                  highlightsHtml += `
                    <div class="mb-1">
                      <i class="fas fa-check-circle text-success"></i> ${highlight}
                    </div>
                  `;
                });
                $("#highlightsList").html(highlightsHtml);
                
                // Auto-scroll to bottom of highlights
                $("#progressHighlights").scrollTop($("#progressHighlights")[0].scrollHeight);
              }

              if (status.status === "completed") {
                clearInterval(checkInterval);
                clearInterval(timeInterval);
                
                // Show completion animation
                $("#analysisProgress")
                  .removeClass("bg-primary")
                  .addClass("bg-success");
                $("#progressStatus").html('<i class="fas fa-check-circle"></i> Analysis Complete!');
                
                // Wait a moment before hiding
                setTimeout(function() {
                  $("#progressModal").modal("hide");
                  // Remove modal from DOM after hiding
                  setTimeout(function() {
                    $("#progressModal").remove();
                  }, 500);
                  
                  currentScenarioParams = gatherParameters();
                  currentScenarioResults = status.result;
                  // Update currentAnalysisId with the export_id from the completed analysis
                  if (status.export_id) {
                    currentAnalysisId = status.export_id;
                    console.log("Updated currentAnalysisId to export_id:", currentAnalysisId);
                  }
                  // Store visualizations in currentScenarioResults for map access
                  if (status.visualizations) {
                    currentScenarioResults.visualizations = status.visualizations;
                  }
                  displayResults(status.result, status.visualizations || {});
                }, 1500);
                
              } else if (status.status === "error") {
                clearInterval(checkInterval);
                clearInterval(timeInterval);
                
                // Show error state
                $("#analysisProgress")
                  .removeClass("bg-primary")
                  .addClass("bg-danger");
                // Use plain text for error status to avoid injecting HTML
                $("#progressStatus").text('Analysis Failed');
                
                // Show error details in highlights
                $("#highlightsList").html(`
                  <div class="text-danger">
                    <i class="fas fa-times-circle"></i> Error: ${status.error}
                  </div>
                  ${status.suggestion ? `<div class="text-warning mt-2"><i class="fas fa-lightbulb"></i> ${status.suggestion}</div>` : ''}
                `);
                
                setTimeout(function() {
                  $("#progressModal").modal("hide");
                  setTimeout(function() {
                    $("#progressModal").remove();
                  }, 500);
                  
                  alert("Analysis error: " + status.error + (status.suggestion ? "\n\n" + status.suggestion : ""));
                }, 2000);
              }
            })
            .fail(function (xhr, status, error) {
              // Continue polling even if one request fails
              console.error("Status check failed:", {
                status: status,
                error: error,
                responseText: xhr.responseText,
                readyState: xhr.readyState,
                statusCode: xhr.status
              });
            });
        }, 2000); // Check every 2 seconds
      }

      // Preset configurations
      const presets = {
        balanced: {
          name: "Balanced Growth",
          economic_targets: {
            gdp_growth: 2.87,
            direct_jobs: 1000,
            indirect_jobs: 2000,
            wage_growth: 8,
            time_horizon: 3,
            min_roi: 15,
          },
          business_filters: {
            min_employees: 5,
            max_employees: 10000,
            min_age: 2,
            min_revenue: 0.1,
            min_growth_rate: 0,
          },
          scoring_weights: {
            business: { innovation: 30, market_potential: 40, competition: 30 },
            cluster: {
              natural_assets: 20,
              infrastructure: 20,
              workforce: 15,
              market_access: 15,
              innovation: 15,
              geopolitical: 10,
              resilience: 5,
            },
          },
        },
        aggressive: {
          name: "Aggressive Growth",
          economic_targets: {
            gdp_growth: 5.0,
            direct_jobs: 2000,
            indirect_jobs: 4000,
            wage_growth: 15,
            time_horizon: 5,
            min_roi: 25,
          },
          business_filters: {
            min_employees: 10,
            max_employees: 5000,
            min_age: 1,
            min_revenue: 0.5,
            min_growth_rate: 10,
          },
          scoring_weights: {
            business: { innovation: 40, market_potential: 40, competition: 20 },
            cluster: {
              natural_assets: 15,
              infrastructure: 15,
              workforce: 20,
              market_access: 20,
              innovation: 20,
              geopolitical: 5,
              resilience: 5,
            },
          },
        },
        conservative: {
          name: "Conservative Growth",
          economic_targets: {
            gdp_growth: 1.5,
            direct_jobs: 500,
            indirect_jobs: 1000,
            wage_growth: 5,
            time_horizon: 3,
            min_roi: 10,
          },
          business_filters: {
            min_employees: 20,
            max_employees: 10000,
            min_age: 5,
            min_revenue: 1.0,
            min_growth_rate: -5,
          },
          scoring_weights: {
            business: { innovation: 20, market_potential: 40, competition: 40 },
            cluster: {
              natural_assets: 25,
              infrastructure: 25,
              workforce: 15,
              market_access: 10,
              innovation: 10,
              geopolitical: 10,
              resilience: 5,
            },
          },
        },
      };

      function loadPreset(presetName) {
        const preset = presets[presetName];
        if (!preset) return;

        // Highlight selected preset
        $(".preset-config").removeClass("selected");
        $(`#preset-${presetName}`).addClass("selected");

        // Load economic targets
        $("#gdpTarget").val(preset.economic_targets.gdp_growth);
        $("#directJobsTarget").val(preset.economic_targets.direct_jobs);
        $("#indirectJobsTarget").val(preset.economic_targets.indirect_jobs);
        $("#wageGrowthTarget").val(preset.economic_targets.wage_growth);
        $("#timeHorizon").val(preset.economic_targets.time_horizon);
        $("#minROI").val(preset.economic_targets.min_roi);

        // Load business filters
        $("#minEmployees").val(preset.business_filters.min_employees);
        $("#maxEmployees").val(preset.business_filters.max_employees);
        $("#businessAge").val(preset.business_filters.min_age);
        $("#minRevenue").val(preset.business_filters.min_revenue);
        $("#minGrowthRate").val(preset.business_filters.min_growth_rate);

        // Load scoring weights
        $("#innovationWeight").val(preset.scoring_weights.business.innovation);
        $("#marketWeight").val(
          preset.scoring_weights.business.market_potential
        );
        $("#competitionWeight").val(
          preset.scoring_weights.business.competition
        );

        $("#naturalAssetsWeight").val(
          preset.scoring_weights.cluster.natural_assets
        );
        $("#infrastructureWeight").val(
          preset.scoring_weights.cluster.infrastructure
        );
        $("#workforceWeight").val(preset.scoring_weights.cluster.workforce);
        $("#marketAccessWeight").val(
          preset.scoring_weights.cluster.market_access
        );
        $("#innovationClusterWeight").val(
          preset.scoring_weights.cluster.innovation
        );
        $("#geopoliticalWeight").val(
          preset.scoring_weights.cluster.geopolitical
        );
        $("#resilienceWeight").val(preset.scoring_weights.cluster.resilience);

        // Update all displays
        updateWeightDisplay();
        $(".weight-slider").trigger("input");
        updateFormProgress();
      }

      function updateFormProgress() {
        console.log("updateFormProgress called");

        // Count filled required fields by section
        let totalRequired = 7; // Total number of sections (Infrastructure is included, Industry Focus removed)
        let filledRequired = 0;

        // 1. Economic Targets
        const gdpVal = $("#gdpTarget").val();
        const directJobsVal = $("#directJobsTarget").val();
        const indirectJobsVal = $("#indirectJobsTarget").val();

        console.log("Economic targets:", {
          gdpVal,
          directJobsVal,
          indirectJobsVal,
        });

        const economicTargetsValid =
          gdpVal &&
          parseFloat(gdpVal) > 0 &&
          directJobsVal &&
          parseFloat(directJobsVal) > 0 &&
          indirectJobsVal &&
          parseFloat(indirectJobsVal) > 0;
        updateSectionStatus("economicTargets", economicTargetsValid);
        if (economicTargetsValid) filledRequired++;

        // 2. Industry & Cluster Focus (REMOVED - Now handled by Strategic Cluster Selection)

        // 3. Geographic Scope
        const countiesSelected =
          $(".county-ks:checked, .county-mo:checked").length > 0;
        console.log(
          "Counties checked:",
          $(".county-ks:checked, .county-mo:checked").length
        );
        updateSectionStatus("geographicScope", countiesSelected);
        if (countiesSelected) filledRequired++;

        // 4. Business Filters (check if has values)
        const businessFiltersValid =
          $("#minEmployees").val() &&
          $("#maxEmployees").val() &&
          $("#minRevenue").val() &&
          $("#businessAge").val();
        updateSectionStatus("businessFilters", businessFiltersValid);
        if (businessFiltersValid) filledRequired++;

        // 5. Scoring Weights
        const businessWeightTotal =
          parseFloat($("#innovationWeight").val() || 0) +
          parseFloat($("#marketWeight").val() || 0) +
          parseFloat($("#competitionWeight").val() || 0);
        const businessWeightsValid = Math.abs(businessWeightTotal - 100) < 0.1;
        console.log(
          "Business weights total:",
          businessWeightTotal,
          "Valid:",
          businessWeightsValid
        );

        const clusterWeights = {
          naturalAssets: parseFloat($("#naturalAssetsWeight").val() || 0),
          infrastructure: parseFloat($("#infrastructureWeight").val() || 0),
          workforce: parseFloat($("#workforceWeight").val() || 0),
          innovation: parseFloat($("#innovationClusterWeight").val() || 0),
          marketAccess: parseFloat($("#marketAccessWeight").val() || 0),
          geopolitical: parseFloat($("#geopoliticalWeight").val() || 0),
          resilience: parseFloat($("#resilienceWeight").val() || 0),
        };

        console.log("Cluster weights:", clusterWeights);

        const clusterWeightTotal = Object.values(clusterWeights).reduce(
          (a, b) => a + b,
          0
        );
        const clusterWeightsValid = Math.abs(clusterWeightTotal - 100) < 0.1;

        console.log(
          "Cluster weight total:",
          clusterWeightTotal,
          "Valid:",
          clusterWeightsValid
        );

        const weightsValid = businessWeightsValid && clusterWeightsValid;
        updateSectionStatus("scoringWeights", weightsValid);
        if (weightsValid) filledRequired++;

        // 6. Data Sources
        const dataSourcesSelected = $('input[id^="source"]:checked').length > 0;
        updateSectionStatus("dataSources", dataSourcesSelected);
        if (dataSourcesSelected) filledRequired++;

        // 7. Algorithm Parameters (automatic discovery always valid)
        const algorithmParamsValid = true;
        updateSectionStatus("algorithmParams", algorithmParamsValid);
        if (algorithmParamsValid) filledRequired++;

        // 8. Infrastructure & Resource Requirements (optional but counted)
        // For now, we'll consider it always ready since it's optional
        const infrastructureValid = true;
        updateSectionStatus("infrastructure", infrastructureValid);
        if (infrastructureValid) filledRequired++;

        console.log(
          "Progress:",
          filledRequired,
          "/",
          totalRequired,
          "=",
          (filledRequired / totalRequired) * 100 + "%"
        );
        console.log("Section statuses:", {
          economicTargets: economicTargetsValid,
          geographicScope: countiesSelected,
          businessFilters: businessFiltersValid,
          scoringWeights: weightsValid,
          dataSources: dataSourcesSelected,
          algorithmParams: algorithmParamsValid,
          infrastructure: infrastructureValid,
        });

        // Log which sections are not ready
        const notReady = [];
        if (!economicTargetsValid) notReady.push("Economic Targets");
        if (!countiesSelected) notReady.push("Geographic Scope");
        if (!businessFiltersValid) notReady.push("Business Filters");
        if (!weightsValid) notReady.push("Scoring Weights");
        if (!dataSourcesSelected) notReady.push("Data Sources");
        if (!algorithmParamsValid) notReady.push("Algorithm Parameters");
        if (!infrastructureValid) notReady.push("Infrastructure");

        if (notReady.length > 0) {
          console.log("Sections not ready:", notReady);
        }

        // Update progress bar
        const progress = (filledRequired / totalRequired) * 100;
        $("#formProgress").css("width", progress + "%");
        $("#formProgress").text(Math.round(progress) + "% Complete");

        console.log(
          "Button update - Progress:",
          progress,
          "Filled:",
          filledRequired,
          "Total:",
          totalRequired
        );

        // Update run button state and text
        const runBtn = $("#runAnalysis");
        if (progress >= 100) {
          // Changed from === to >= for floating point safety
          console.log("Enabling run button");
          runBtn
            .removeClass("btn-secondary")
            .addClass("btn-primary")
            .prop("disabled", false);
          runBtn.html('<i class="fas fa-play-circle"></i> Run Analysis');
        } else {
          console.log("Disabling run button");
          runBtn
            .removeClass("btn-primary")
            .addClass("btn-secondary")
            .prop("disabled", true);
          runBtn.html(
            `<i class="fas fa-exclamation-circle"></i> Complete All Sections First`
          );
        }
      }

      function updateSectionStatus(sectionId, isValid) {
        const statusBadge = $(`#${sectionId}Status`);
        console.log(
          "Updating section:",
          sectionId,
          "Valid:",
          isValid,
          "Element found:",
          statusBadge.length > 0
        );

        // Additional debug for specific sections having issues
        if (
          sectionId === "scoringWeights" ||
          sectionId === "geographicScope" ||
          sectionId === "economicTargets"
        ) {
          console.log(`Debug ${sectionId} - Badge element:`, statusBadge[0]);
        }

        if (statusBadge.length === 0) {
          console.error(`Cannot find status badge for section: ${sectionId}`);
          return;
        }

        if (isValid) {
          statusBadge
            .removeClass("bg-secondary bg-danger")
            .addClass("bg-success")
            .text("Ready");
        } else {
          statusBadge
            .removeClass("bg-success bg-danger")
            .addClass("bg-secondary")
            .text("Not Ready");
        }
      }

      function highlightProblematicFields(filterReasons) {
        // Clear previous highlights
        $(".form-control, .form-check-input").removeClass(
          "is-invalid filter-problem"
        );
        $(".filter-feedback").remove();

        // Highlight fields based on filter reasons
        if (filterReasons.employees > 0) {
          $("#minEmployees, #maxEmployees").addClass(
            "is-invalid filter-problem"
          );
          $("#minEmployees").after(
            '<div class="invalid-feedback filter-feedback">Too restrictive - ' +
              filterReasons.employees +
              " businesses filtered</div>"
          );
        }

        if (filterReasons.revenue > 0) {
          $("#minRevenue").addClass("is-invalid filter-problem");
          $("#minRevenue").after(
            '<div class="invalid-feedback filter-feedback">Too high - ' +
              filterReasons.revenue +
              " businesses filtered</div>"
          );
        }

        if (filterReasons.age > 0) {
          $("#businessAge").addClass("is-invalid filter-problem");
          $("#businessAge").after(
            '<div class="invalid-feedback filter-feedback">Too restrictive - ' +
              filterReasons.age +
              " businesses filtered</div>"
          );
        }

        if (filterReasons.geography > 0) {
          $('input[name="geoFocus"]').addClass("is-invalid filter-problem");
          $("#geographicFocusWarning").html(
            '<i class="fas fa-exclamation-triangle"></i> Geographic focus is filtering out ' +
              filterReasons.geography +
              " businesses"
          );
          $("#geographicFocusWarning").show();
        }

        if (filterReasons.patents > 0) {
          $("#requirePatents").addClass("is-invalid filter-problem");
          $("#requirePatents")
            .parent()
            .append(
              '<div class="text-danger filter-feedback small">Filtering out ' +
                filterReasons.patents +
                " businesses</div>"
            );
        }

        if (filterReasons.sbir > 0) {
          $("#requireSBIR").addClass("is-invalid filter-problem");
          $("#requireSBIR")
            .parent()
            .append(
              '<div class="text-danger filter-feedback small">Filtering out ' +
                filterReasons.sbir +
                " businesses</div>"
            );
        }

        if (filterReasons.growth > 0) {
          $("#minGrowthRate").addClass("is-invalid filter-problem");
          $("#minGrowthRate").after(
            '<div class="invalid-feedback filter-feedback">Too high - ' +
              filterReasons.growth +
              " businesses filtered</div>"
          );
        }

        // Scroll to the first problematic field
        const firstProblem = $(".filter-problem:first");
        if (firstProblem.length) {
          // Show the clear filters button
          $("#clearFiltersBtn").show();

          // Open the accordion section containing the problematic field
          const accordion = firstProblem.closest(".accordion-collapse");
          if (accordion.length && !accordion.hasClass("show")) {
            accordion.collapse("show");
          }

          // Scroll to the field
          setTimeout(() => {
            $("html, body").animate(
              {
                scrollTop: firstProblem.offset().top - 100,
              },
              500
            );
          }, 300);
        }
      }

      function clearProblematicFilters() {
        // Clear employee filters to defaults
        $("#minEmployees").val("5").removeClass("is-invalid filter-problem");
        $("#maxEmployees")
          .val("10000")
          .removeClass("is-invalid filter-problem");

        // Clear revenue filter to minimum
        $("#minRevenue").val("0").removeClass("is-invalid filter-problem");

        // Clear business age to minimum
        $("#businessAge").val("0").removeClass("is-invalid filter-problem");

        // Reset geographic focus to all areas
        $("#focusAll").prop("checked", true);
        $('input[name="geoFocus"]').removeClass("is-invalid filter-problem");
        $("#geographicFocusWarning").hide();
        handleGeographicFocusChange();

        // Uncheck additional filters
        $("#requirePatents")
          .prop("checked", false)
          .removeClass("is-invalid filter-problem");
        $("#requireSBIR")
          .prop("checked", false)
          .removeClass("is-invalid filter-problem");

        // Clear growth rate
        $("#minGrowthRate").val("0").removeClass("is-invalid filter-problem");

        // Remove all feedback messages
        $(".filter-feedback").remove();

        // Hide the clear filters button
        $("#clearFiltersBtn").hide();

        // Hide validation summary
        $("#validationSummary").hide();

        // Update form progress
        updateFormProgress();

        // Show success message
        const successMsg = $(
          '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
            '<i class="fas fa-check-circle"></i> Filters have been reset to less restrictive values. You can now run the analysis.' +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            "</div>"
        );
        $("#validationSummary").after(successMsg);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          successMsg.fadeOut(() => successMsg.remove());
        }, 5000);
      }

      function validateForm() {
        console.log("\n=== VALIDATING FORM ===");
        const errors = [];
        let isValid = true;

        // Clear previous validation
        $(".is-invalid").removeClass("is-invalid");
        $("#validationSummary").hide();
        $("#validationErrors").empty();

        // Check required fields
        const gdpTarget = parseFloat($("#gdpTarget").val());
        if (!gdpTarget || gdpTarget <= 0) {
          $("#gdpTarget").addClass("is-invalid");
          errors.push("GDP Growth Target must be greater than 0");
          isValid = false;
        }

        const directJobs = parseInt($("#directJobsTarget").val());
        if (!directJobs || directJobs <= 0) {
          $("#directJobsTarget").addClass("is-invalid");
          errors.push("Direct Jobs Target must be greater than 0");
          isValid = false;
        }

        // Check at least one data source is selected
        const dataSourcesSelected = $('input[id^="source"]:checked').length;
        if (dataSourcesSelected === 0) {
          errors.push("At least one data source must be selected");
          isValid = false;
        }

        // Check at least one county is selected
        const countiesSelected = $(
          ".county-ks:checked, .county-mo:checked"
        ).length;
        if (countiesSelected === 0) {
          errors.push("At least one county must be selected");
          isValid = false;
        }


        // Validate business scoring weights sum to 100%
        const businessWeightSum =
          parseInt($("#innovationWeight").val()) +
          parseInt($("#marketWeight").val()) +
          parseInt($("#competitionWeight").val());
        if (businessWeightSum !== 100) {
          errors.push(
            "Business scoring weights must sum to 100% (currently " +
              businessWeightSum +
              "%)"
          );
          isValid = false;
        }

        // Validate cluster scoring weights sum to 100%
        const clusterWeightSum =
          parseInt($("#naturalAssetsWeight").val()) +
          parseInt($("#infrastructureWeight").val()) +
          parseInt($("#workforceWeight").val()) +
          parseInt($("#marketAccessWeight").val()) +
          parseInt($("#innovationClusterWeight").val()) +
          parseInt($("#geopoliticalWeight").val()) +
          parseInt($("#resilienceWeight").val());
        if (clusterWeightSum !== 100) {
          errors.push(
            "Cluster scoring weights must sum to 100% (currently " +
              clusterWeightSum +
              "%)"
          );
          isValid = false;
        }

        // Show errors if any
        if (!isValid) {
          errors.forEach((error) => {
            $("#validationErrors").append("<li>" + error + "</li>");
          });
          $("#validationSummary").show();
          window.scrollTo(0, 0);
        }

        return isValid;
      }

      function updateWeightDisplay() {
        $("#innovationWeightValue").text($("#innovationWeight").val() + "%");
        $("#marketWeightValue").text($("#marketWeight").val() + "%");
        $("#competitionWeightValue").text($("#competitionWeight").val() + "%");
      }

      function validateWeights() {
        const innovation = parseInt($("#innovationWeight").val());
        const market = parseInt($("#marketWeight").val());
        const competition = parseInt($("#competitionWeight").val());
        const total = innovation + market + competition;

        $("#weightTotal").text(total + "%");
        if (total !== 100) {
          $("#weightTotal").parent().addClass("text-danger");
        } else {
          $("#weightTotal").parent().removeClass("text-danger");
        }
      }

      function validateClusterWeights() {
        const naturalAssets = parseInt($("#naturalAssetsWeight").val());
        const infrastructure = parseInt($("#infrastructureWeight").val());
        const workforce = parseInt($("#workforceWeight").val());
        const marketAccess = parseInt($("#marketAccessWeight").val());
        const innovation = parseInt($("#innovationClusterWeight").val());
        const geopolitical = parseInt($("#geopoliticalWeight").val());
        const resilience = parseInt($("#resilienceWeight").val());

        const total =
          naturalAssets +
          infrastructure +
          workforce +
          marketAccess +
          innovation +
          geopolitical +
          resilience;

        $("#clusterWeightTotal").text(total + "%");
        if (total !== 100) {
          $("#clusterWeightTotal").parent().addClass("text-danger");
        } else {
          $("#clusterWeightTotal").parent().removeClass("text-danger");
        }
      }

      function handleGeographicFocusChange() {
        const selectedFocus = $('input[name="geoFocus"]:checked').val();

        // Reset all county items
        $(".county-item").removeClass("highlighted dimmed");
        
        // Update help text and warnings
        const helpText = $("#geoFocusHelp");
        const warningDiv = $("#geoFocusWarning");
        const warningText = $("#geoFocusWarningText");
        
        switch(selectedFocus) {
          case "all":
            helpText.text("All Areas: Includes all businesses in selected counties");
            warningDiv.hide();
            break;
          case "urban":
            helpText.text("Urban Core: Only includes businesses in Jackson, Clay, Platte (MO) and Johnson, Wyandotte (KS) counties");
            warningText.text("This filter may significantly reduce the number of businesses analyzed. Consider using 'All Areas' if you get no results.");
            warningDiv.show();
            break;
          case "suburban":
            helpText.text("Suburban: Only includes businesses in Cass, Leavenworth, and Miami counties");
            warningText.text("This filter may significantly reduce the number of businesses analyzed. Consider using 'All Areas' if you get no results.");
            warningDiv.show();
            break;
        }

        // Update focus mode indicator
        const focusIndicator = $("#focusModeIndicator");
        const focusText = $("#focusModeText");

        if (selectedFocus === "all") {
          focusIndicator.removeClass("active urban suburban rural");
          // No highlighting when "All Areas" is selected
          return;
        }

        // Show and style the focus indicator
        focusIndicator.addClass("active " + selectedFocus);

        // Set appropriate message
        let message = "";
        let autoSelectMessage = "";
        switch (selectedFocus) {
          case "urban":
            message =
              "Urban Core Focus: Highlighting counties in the metropolitan core areas.";
            autoSelectMessage =
              'Counties marked as "Urban" are recommended for this analysis.';
            break;
          case "suburban":
            message =
              "Suburban Focus: Highlighting counties in the suburban ring.";
            autoSelectMessage =
              'Counties marked as "Suburban" are recommended for this analysis.';
            break;
          case "rural":
            message = "Rural Focus: Highlighting counties in rural areas.";
            autoSelectMessage =
              'Counties marked as "Rural" are recommended for this analysis.';
            break;
        }

        focusText.html(
          message + " <br><small>" + autoSelectMessage + "</small>"
        );

        // Highlight matching counties and dim others
        $(".county-item").each(function () {
          const countyType = $(this).data("county-type");
          if (countyType === selectedFocus) {
            $(this).addClass("highlighted");
          } else {
            $(this).addClass("dimmed");
          }
        });

        // Add action buttons to the focus indicator
        const actionButtons =
          '<div class="mt-2">' +
          '<button class="btn btn-sm btn-primary me-2" onclick="autoSelectCountiesByFocus(\'' +
          selectedFocus +
          "')\">Select Only " +
          selectedFocus.charAt(0).toUpperCase() +
          selectedFocus.slice(1) +
          " Counties</button>" +
          '<button class="btn btn-sm btn-outline-secondary" onclick="resetCountySelection()">Reset Selection</button>' +
          "</div>";

        focusText.append(actionButtons);
      }

      // Make these functions globally accessible for button onclick
      window.autoSelectCountiesByFocus = function (focus) {
        // First, uncheck all counties
        $(".county-ks, .county-mo").prop("checked", false);

        // Then check only counties matching the focus
        $(".county-item").each(function () {
          const countyType = $(this).data("county-type");
          if (countyType === focus) {
            $(this).find('input[type="checkbox"]').prop("checked", true);
          }
        });

        // Update form progress
        updateFormProgress();
      };

      window.resetCountySelection = function () {
        // Check all counties (default state)
        $(".county-ks, .county-mo").prop("checked", true);

        // Update form progress
        updateFormProgress();
      };

      function handleAdditionalFilterChange() {
        const activeFilters = $(".additional-filter:checked");
        const filterWarning = $("#additionalFilterWarning");

        if (activeFilters.length > 0) {
          // Count active filters and show warning
          const filterTypes = [];
          activeFilters.each(function () {
            const filterType = $(this).data("filter-type");
            switch (filterType) {
              case "patents":
                filterTypes.push("patent holders");
                break;
              case "sbir":
                filterTypes.push("SBIR/STTR recipients");
                break;
            }
          });

          let warningMessage = `<strong>Warning:</strong> You have ${
            activeFilters.length
          } restrictive filter${activeFilters.length > 1 ? "s" : ""} active. `;
          warningMessage += `Only businesses that are ${filterTypes.join(
            " AND "
          )} will be included in the analysis. `;
          warningMessage += `This may significantly reduce the number of eligible businesses.`;

          filterWarning.html(warningMessage).show();
        } else {
          filterWarning.hide();
        }
      }

      function handleInfrastructureChange() {
        const activePrefs = $(".infrastructure-pref:checked");
        const impactDiv = $("#infrastructureImpact");
        const impactText = $("#infrastructureImpactText");

        if (activePrefs.length > 0) {
          // Collect cluster types that benefit from selected infrastructure
          const benefitingClusters = new Set();
          activePrefs.each(function () {
            const clusterTypes = $(this).data("cluster-types").split(",");
            clusterTypes.forEach((type) => benefitingClusters.add(type));
          });

          const clusterArray = Array.from(benefitingClusters);
          let message = `Selected preferences will boost scores for <strong>${clusterArray.join(
            ", "
          )}</strong> clusters. `;
          message += `Clusters matching more of your selected infrastructure will rank higher.`;

          impactText.html(message);
          impactDiv.show();
        } else {
          impactDiv.hide();
        }
      }

      function showLoading() {
        $("#loadingOverlay").css("display", "flex");
      }

      function hideLoading() {
        $("#loadingOverlay").hide();
      }

      function formatCurrency(value) {
        // Fix floating point precision issues
        value = Math.round(value);
        
        if (value >= 1e9) {
          return "$" + (value / 1e9).toFixed(1) + "B";
        } else if (value >= 1e6) {
          return "$" + (value / 1e6).toFixed(1) + "M";
        } else {
          return "$" + value.toLocaleString();
        }
      }
      
      function formatNumber(value) {
        // Generic number formatter for non-currency values
        value = parseFloat(value);
        
        if (value >= 1e9) {
          return (value / 1e9).toFixed(1) + "B";
        } else if (value >= 1e6) {
          return (value / 1e6).toFixed(1) + "M";
        } else if (value >= 1e3) {
          return (value / 1e3).toFixed(1) + "K";
        } else {
          return Math.round(value).toLocaleString();
        }
      }
      
      function displayLongevityScore(cluster, allClusters) {
        if (!cluster.longevity_score) return '';
        
        // Check if all clusters have the same longevity score (placeholder data)
        if (allClusters && allClusters.length > 1) {
          const scores = allClusters.map(c => c.longevity_score).filter(s => s !== undefined);
          const allSame = scores.every(score => Math.abs(score - scores[0]) < 0.1);
          
          if (allSame) {
            return ''; // Don't display placeholder longevity scores
          }
        }
        
        return `<p><strong>Longevity Score:</strong> ${Math.round(cluster.longevity_score)}/100</p>`;
      }

      function gatherParameters() {
        console.log("\n=== GATHERING USER PARAMETERS ===");
        console.log("Timestamp:", new Date().toISOString());
        
        // Gather all user inputs comprehensively
        const params = {
          economic_targets: {
            gdp_growth: parseFloat($("#gdpTarget").val()) * 1e9, // Convert to dollars
            direct_jobs: parseInt($("#directJobsTarget").val()),
            indirect_jobs: parseInt($("#indirectJobsTarget").val()),
            wage_growth: parseFloat($("#wageGrowthTarget").val()) / 100,
            time_horizon: parseInt($("#timeHorizon").val()),
            min_roi: parseFloat($("#minROI").val()) / 100,
          },
          geographic_scope: {
            kansas_counties: $(".county-ks:checked")
              .map(function () {
                return $(this).val();
              })
              .get(),
            missouri_counties: $(".county-mo:checked")
              .map(function () {
                return $(this).val();
              })
              .get(),
            focus: $('input[name="geoFocus"]:checked').val(),
          },
          // Industry focus now handled by algorithm_params.selected_clusters
          business_filters: {
            min_employees: parseInt($("#minEmployees").val()),
            max_employees: parseInt($("#maxEmployees").val()),
            min_age: parseInt($("#businessAge").val()), // Fixed: backend expects min_age
            min_revenue: parseFloat($("#minRevenue").val()) * 1e6, // Convert to dollars
            min_growth_rate: parseFloat($("#minGrowthRate").val()) / 100,
            require_patents: $("#filterPatents").is(":checked"),
            require_sbir: $("#filterSBIR").is(":checked"),
            excluded_naics: [], // TODO: Add UI for NAICS exclusions
          },
          scoring_weights: {
            business: {
              // Fixed: backend expects 'business' not 'business_weights'
              innovation: parseFloat($("#innovationWeight").val()) / 100,
              market_potential: parseFloat($("#marketWeight").val()) / 100,
              competition: parseFloat($("#competitionWeight").val()) / 100,
            },
            cluster: {
              // Fixed: backend expects 'cluster' not 'cluster_weights'
              natural_assets: parseFloat($("#naturalAssetsWeight").val()) / 100,
              infrastructure:
                parseFloat($("#infrastructureWeight").val()) / 100,
              workforce: parseFloat($("#workforceWeight").val()) / 100,
              innovation:
                parseFloat($("#innovationClusterWeight").val() || 15) / 100, // Added missing
              market_access: parseFloat($("#marketAccessWeight").val()) / 100,
              geopolitical:
                parseFloat($("#geopoliticalWeight").val() || 10) / 100, // Added missing
              resilience: parseFloat($("#resilienceWeight").val() || 5) / 100, // Added missing
            },
          },
          data_sources: (() => {
            // Convert boolean flags to list of enabled sources
            const sources = [];
            if ($("#sourceStateRegistries").is(":checked"))
              sources.push("state_registrations");
            if ($("#sourceBLS").is(":checked")) sources.push("bls_employment");
            if ($("#sourceUSPTO").is(":checked")) sources.push("uspto_patents");
            if ($("#sourceSBIR").is(":checked")) sources.push("sbir_awards");
            if ($("#sourceEDCKC").is(":checked"))
              sources.push("infrastructure_assets");
            return sources;
          })(),
          infrastructure_requirements: (() => {
            // Convert boolean flags to list of required infrastructure
            const requirements = [];
            if ($("#requireRail").is(":checked"))
              requirements.push("rail_access");
            if ($("#requireHighway").is(":checked"))
              requirements.push("highway_access");
            if ($("#requireAirport").is(":checked"))
              requirements.push("air_cargo");
            if ($("#requireBroadband").is(":checked"))
              requirements.push("broadband");
            if ($("#requireSTEM").is(":checked"))
              requirements.push("stem_workforce");
            if ($("#requireUniversity").is(":checked"))
              requirements.push("university_partnership");
            if ($("#requireSkilled").is(":checked"))
              requirements.push("skilled_trades");
            return requirements;
          })(),
          algorithm_params: {
            // Automatic discovery - no manual cluster parameters needed
            // pareto_threshold handled automatically by backend based on data distribution
            optimization_focus: $("#optimizationFocus").val(),
          },
          use_ml_enhancement: $("#mlEnhancement").val() !== "false",
          use_kc_features: $("#mlEnhancement").val() === "enhanced",
          visualization_mode: "improved",  // Always use improved mode (Enhanced boundaries)
        };

        // Log final parameters
        console.log("\nFINAL PARAMETERS OBJECT:");
        console.log(JSON.stringify(params, null, 2));
        
        return params;
      }

      function runAnalysis() {
        // Validate form first
        if (!validateForm()) {
          return;
        }

        const params = gatherParameters();

        // Add mode-specific parameters
        const isQuickMode = $("#quickMode").is(":checked");
        params.quick_mode = isQuickMode;

        // Ensure ML enhancement is always enabled for intelligent clustering
        const mlSetting = $("#mlEnhancement").val();
        params.use_ml_enhancement = mlSetting !== "false";
        params.use_kc_features = mlSetting === "enhanced";

        // Override some parameters based on mode
        if (isQuickMode) {
          // Quick mode defaults: skip patents and reduce sample for speed
          params.sample_size = 2000;
          params.skip_patents = true;
        }

        // Enhanced logging for debugging
        console.log("\n=== ANALYSIS SUBMISSION ===");
        console.log("Timestamp:", new Date().toISOString());
        console.log("Analysis Mode:", isQuickMode ? "Quick" : "Full");
        console.log("\nCOMPLETE PARAMETERS:");
        console.log(JSON.stringify(params, null, 2));
        
        // Log key parameters separately for clarity
        console.log("\nKEY INPUTS:");
        console.log("- GDP Target: $" + ((params.economic_targets?.gdp_growth || 0) / 1e9).toFixed(2) + "B");
        console.log("- Direct Jobs Target:", params.economic_targets?.direct_jobs || 0);
        console.log("- Counties Selected:", params.geographic_scope?.counties?.length || 0);
        console.log("- Geographic Focus:", params.geographic_scope?.focus || "Not specified");
        console.log("- Business Filters:");
        console.log("  - Min Employees:", params.business_filters?.min_employees || 0);
        console.log("  - Max Employees:", params.business_filters?.max_employees || "No limit");
        console.log("  - Min Revenue: $" + ((params.business_filters?.min_revenue || 0) / 1e6).toFixed(1) + "M");
        console.log("  - Industries:", params.business_filters?.industries?.join(", ") || "All");
        console.log("- Algorithm:");
        console.log("  - Optimization Focus:", params.algorithm_params?.optimization_focus || "balanced");
        console.log("  - Num Clusters:", params.algorithm_params?.num_clusters || "auto");
        console.log("  - Cluster Size:", (params.algorithm_params?.cluster_size?.min || 10) + "-" + (params.algorithm_params?.cluster_size?.max || 100));

        showLoading();

        // Update loading message based on mode
        const loadingMessage = isQuickMode
          ? "Running quick analysis with ML intelligence... This may take 3-5 minutes."
          : "Running comprehensive analysis... This may take 2-3 hours.";
        $("#loadingOverlay p").text(loadingMessage);

        $.ajax({
          url: "/api/run_analysis_async",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(params),
          success: function (response) {
            console.log("\n=== ANALYSIS RESPONSE RECEIVED ===");
            console.log("Response status:", response.status);
            console.log("Response keys:", Object.keys(response));
            
            hideLoading();
            if (response.status === "Analysis started") {
              // Handle async analysis response
              currentAnalysisId = response.task_id;
              // Show progress monitoring
              monitorAsyncProgress(response.task_id);
            } else if (response.status === "success") {
              // Direct results for quick analyses
              console.log("Direct results received (quick analysis)");
              console.log("Results structure:", Object.keys(response.results || {}));
              
              hideLoading();
              // Store the appropriate ID for exports - DO NOT use timestamp
              if (response.results.export_id) {
                currentAnalysisId = response.results.export_id;
              } else if (response.results.task_id) {
                currentAnalysisId = response.results.task_id;
              } else if (response.task_id) {
                // Use the task_id from the initial response if available
                currentAnalysisId = response.task_id;
              }
              currentScenarioParams = params;
              currentScenarioResults = response.results;
              
              // Check if all businesses were filtered out
              if (response.results.error && response.results.error.includes("All businesses were filtered")) {
                // Show helpful error message
                const filterSummary = response.results.filter_summary || {};
                let message = "No businesses matched your criteria.\n\n";
                
                if (filterSummary.geography > 0) {
                  message += `Geographic focus '${params.geographic_scope.focus}' filtered out ${filterSummary.geography.toLocaleString()} businesses.\n`;
                  message += "Try selecting 'All Areas' for geographic focus.\n\n";
                }
                
                if (filterSummary.growth > 0) {
                  message += `Growth rate filter removed ${filterSummary.growth.toLocaleString()} businesses.\n`;
                  message += "Consider lowering the minimum growth rate requirement.\n\n";
                }
                
                message += "Would you like to adjust filters and try again?";
                
                if (confirm(message)) {
                  // Reset geographic focus to "All Areas"
                  $("#focusAll").prop("checked", true).trigger("change");
                  // Optionally lower growth rate requirement
                  if (filterSummary.growth > 0) {
                    $("#minGrowthRate").val("0");
                  }
                }
              } else {
                console.log("\n=== ANALYSIS COMPLETED SUCCESSFULLY ===");
                displayResults(response.results, response.visualizations);
              }
            } else {
              hideLoading();
              alert("Analysis failed: " + response.message);
            }
          },
          error: function (xhr, status, error) {
            hideLoading();
            console.error("\n=== ANALYSIS ERROR ===");
            console.error("Status:", status);
            console.error("Error:", error);
            console.error("Response:", xhr.responseText);
            
            let errorMessage = "Error running analysis: " + error;
            let errorDetails = null;
            try {
              errorDetails = JSON.parse(xhr.responseText);
              if (errorDetails.error) {
                errorMessage = errorDetails.error;

                // Check if it's a filtering issue
                if (errorDetails.filter_summary) {
                  errorMessage +=
                    "\n\n" + errorDetails.filter_summary.suggestion;
                }
              }
            } catch (e) {
              console.error("Error parsing response:", e);
              console.error("Raw response:", xhr.responseText);
            }

            // Show error in a more user-friendly way
            console.error("Analysis error:", errorDetails || xhr.responseText);

            // Parse the error message to highlight specific fields
            if (
              errorDetails &&
              errorDetails.filter_summary &&
              errorDetails.filter_summary.filter_reasons
            ) {
              highlightProblematicFields(
                errorDetails.filter_summary.filter_reasons
              );
            }

            $("#validationSummary")
              .html(
                '<h6><i class="fas fa-exclamation-triangle"></i> Analysis Error</h6>' +
                  '<div class="alert alert-danger">' +
                  errorMessage
                    .replace(/\n/g, "<br>")
                    .replace(/•/g, '<i class="fas fa-chevron-right"></i>') +
                  "</div>" +
                  "<ul>" +
                  '<li>Try selecting "All Areas" instead of a specific geographic focus</li>' +
                  "<li>Reduce the minimum business age requirement</li>" +
                  "<li>Lower the minimum employee or revenue thresholds</li>" +
                  "<li>Uncheck any additional business filters</li>" +
                  "</ul>"
              )
              .show();

            // Scroll to validation summary
            $("html, body").animate(
              {
                scrollTop: $("#validationSummary").offset().top - 100,
              },
              500
            );
          },
        });
      }

      function displayResults(results, visualizations) {
        console.log("\n=== DISPLAYING RESULTS ===");
        
        // Initialize tooltipData once to prevent redeclaration errors
        if (typeof window.tooltipData === 'undefined') {
          window.tooltipData = {};
        }
        
        // Initialize applyFilters function if not exists
        if (typeof window.applyFilters === 'undefined') {
          window.applyFilters = function(filters) {
            console.log("Applying filters:", filters);
            // Filter clusters based on selected criteria
            const clusters = results.steps?.cluster_optimization?.clusters || [];
            const filteredClusters = clusters.filter(cluster => {
              // Check if cluster matches filter criteria
              if (filters.type && cluster.type !== filters.type) return false;
              if (filters.minScore && (cluster.cluster_score || cluster.total_score || 0) < filters.minScore) return false;
              if (filters.minBusinesses && (cluster.business_count || 0) < filters.minBusinesses) return false;
              return true;
            });
            
            // Update cluster details display with filtered results
            displayClusterDetails(filteredClusters);
            
            // Update map if available
            if (currentScenarioResults && currentScenarioResults.visualizations && currentScenarioResults.visualizations.cluster_map) {
              // Update map markers to show only filtered clusters
              updateMapMarkers(filteredClusters);
            }
          };
        }
        
        // Initialize updateMapMarkers function if not exists
        if (typeof window.updateMapMarkers === 'undefined') {
          window.updateMapMarkers = function(clusters) {
            console.log("Updating map markers for", clusters.length, "clusters");
            // This function will be called when the map is loaded
            // The actual implementation depends on the map library being used
            // For now, just store the filtered clusters for later use
            window.filteredClusters = clusters;
          };
        }
        console.log("Timestamp:", new Date().toISOString());
        console.log("Analysis ID:", results.export_id || results.timestamp);
        
        // Log complete results for debugging
        console.log("\nCOMPLETE RESULTS OBJECT:");
        console.log(JSON.stringify(results, null, 2));
        
        // Debug specific sections
        console.log("\n=== DATA AVAILABILITY CHECK ===");
        console.log("ML Explanations:", results.ml_explanations ? "Present" : "Missing");
        console.log("Market Analysis:", results.market_analysis ? "Present" : "Missing");
        console.log("Recommendations:", results.steps?.recommendations ? "Present" : "Missing");
        console.log("SBIR Analysis:", results.sbir_analysis ? "Present" : "Missing");
        
        // Store export ID - DO NOT use timestamp as fallback
        if (results.export_id) {
          currentAnalysisId = results.export_id;
          console.log("Using export_id for exports:", currentAnalysisId);
        } else if (results.task_id) {
          currentAnalysisId = results.task_id;
          console.log("Using task_id for exports:", currentAnalysisId);
        } else {
          console.warn("No valid ID found for export functionality. Exports may not work.");
          // Keep the existing currentAnalysisId if available (from initial task creation)
        }

        // Show all sections including new ML sections
        console.log("Showing result sections...");
        $("#metricsSection").show();
        $("#visualizationsSection").show();
        $("#naturalCommunitiesSection").show();
        $("#clusterDetailsSection").show();
        $("#mlInsightsSection").show();
        $("#marketMonitoringSection").show();
        $("#recommendationsSection").show();
        $("#reportSection").show();
        console.log("ML Insights section visible?", $("#mlInsightsSection").is(":visible"));
        console.log("Market Monitoring section visible?", $("#marketMonitoringSection").is(":visible"));
        console.log("Recommendations section visible?", $("#recommendationsSection").is(":visible"));

        // Update metrics
        const impact = results.economic_impact;
        
        // Log key results
        console.log("\nKEY RESULTS:");
        console.log("- Total Clusters:", results.total_clusters || "N/A");
        console.log("- Businesses Analyzed:", results.total_businesses || "N/A");
        console.log("- GDP Impact: $" + ((impact?.projected_gdp_impact || 0) / 1e9).toFixed(2) + "B");
        console.log("- Jobs Created:", impact?.projected_direct_jobs || "N/A");
        console.log("- ROI:", ((impact?.roi || 0) * 100).toFixed(1) + "%");
        console.log("- Target Achievement:", (impact?.gdp_target_achievement || 0).toFixed(1) + "%");
        $("#gdpImpact").text(formatCurrency(impact.projected_gdp_impact));
        $("#totalJobs").text(
          Math.round(impact.projected_total_jobs).toLocaleString()
        );
        $("#clustersFound").text(
          results.steps.cluster_optimization.clusters_identified
        );
        
        // Add natural communities context if available
        if (results.steps.cluster_optimization.natural_communities_found) {
          $("#clustersFound").append(`
            <small class="d-block text-muted" style="font-size: 0.8em; margin-top: 2px;">
              from ${results.steps.cluster_optimization.natural_communities_found} natural communities
            </small>
          `);
        }

        // Update Target Status badge (restored tile)
        (function(){
          const meets = !!(impact && impact.meets_targets);
          const $badge = $("#targetStatusBadge");
          $badge.removeClass('status-success status-pending').empty();
          const $icon = $('<i>').addClass(meets ? 'fas fa-check me-1' : 'fas fa-xmark me-1');
          $badge.append($icon).append(meets ? 'Meets Targets' : 'Below Targets');
          $badge.addClass(meets ? 'status-success' : 'status-pending');
        })();
        
        // Update new metrics if available
        if (impact.projected_wage_growth !== undefined) {
          $("#wageGrowth").text(impact.projected_wage_growth.toFixed(1) + "%");
        }
        if (impact.projected_roi !== undefined) {
          $("#projectedROI").text(impact.projected_roi.toFixed(0) + "%");
        }
        if (impact.total_investment_required !== undefined) {
          $("#investmentRequired").text("$" + (impact.total_investment_required / 1e6).toFixed(1) + "M");
        }
        
        // Update analysis mode
        const quickMode = results.parameters?.quick_mode || false;
        const optimizationFocus = results.parameters?.algorithm_params?.optimization_focus || 'balanced';
        $("#analysisMode").text(quickMode ? "Quick" : "Full");
        
        // You can also display optimization focus somewhere
        console.log("Analysis was run with optimization focus:", optimizationFocus);

        // Display visualizations
        console.log("\n=== RENDERING VISUALIZATIONS ===");
        console.log("Available visualizations:", Object.keys(visualizations || {}));
        if (visualizations && visualizations.gdp_chart) {
          try {
            const gdpData = JSON.parse(visualizations.gdp_chart);
            console.log("Rendering GDP Chart:");
            console.log("- Data points:", gdpData.data.length);
            console.log("- Chart type:", gdpData.data[0]?.type || "unknown");
            Plotly.newPlot("gdpChart", gdpData.data, gdpData.layout);
            console.log("✓ GDP Chart rendered successfully");
          } catch (e) {
            console.error("✗ Error rendering GDP chart:", e);
            console.error("Chart data:", visualizations.gdp_chart?.substring(0, 200) + "...");
          }
        } else {
          console.warn("GDP chart data not available");
        }

        if (visualizations && visualizations.jobs_chart) {
          try {
            const jobsData = JSON.parse(visualizations.jobs_chart);
            console.log("Rendering Jobs Chart:");
            console.log("- Data points:", jobsData.data.length);
            console.log("- Chart type:", jobsData.data[0]?.type || "unknown");
            Plotly.newPlot("jobsChart", jobsData.data, jobsData.layout);
            console.log("✓ Jobs Chart rendered successfully");
          } catch (e) {
            console.error("✗ Error rendering jobs chart:", e);
            console.error("Chart data:", visualizations.jobs_chart?.substring(0, 200) + "...");
          }
        } else {
          console.warn("Jobs chart data not available");
        }

        if (visualizations && visualizations.spider_chart) {
          try {
            const spiderData = JSON.parse(visualizations.spider_chart);
            Plotly.newPlot("spiderChart", spiderData.data, spiderData.layout);
          } catch (e) {
            console.error("Error rendering spider chart:", e);
          }
        }

        if (visualizations && visualizations.business_pie) {
          try {
            const pieData = JSON.parse(visualizations.business_pie);
            Plotly.newPlot("businessPie", pieData.data, pieData.layout);
          } catch (e) {
            console.error("Error rendering business pie chart:", e);
          }
        }

        if (visualizations && visualizations.gauge_chart) {
          try {
            const gaugeData = JSON.parse(visualizations.gauge_chart);
            Plotly.newPlot("gaugeChart", gaugeData.data, gaugeData.layout);
          } catch (e) {
            console.error("Error rendering gauge chart:", e);
          }
        }

        // Log visualization summary
        console.log("\nVISUALIZATION SUMMARY:");
        const vizTypes = Object.keys(visualizations || {});
        console.log("- Total visualizations available:", vizTypes.length);
        console.log("- Types:", vizTypes.join(", "));
        
        // Display cluster details with ML enhancements
        const clusters = results.steps?.cluster_optimization?.clusters || [];
        console.log("\n=== DISPLAYING CLUSTER DETAILS ===");
        console.log("Number of clusters:", clusters.length);
        if (clusters.length > 0) {
          console.log("Top 3 clusters:");
          clusters.slice(0, 3).forEach((cluster, idx) => {
            // Derive safe values as used by displayClusterDetails
            let gdp = 0;
            let jobs = 0;
            if (cluster.ml_predictions) {
              gdp = Number(cluster.ml_predictions.gdp_impact) || 0;
              jobs = Number(cluster.ml_predictions.job_creation) || 0;
            }
            if (!gdp && cluster.metrics) {
              gdp = Number(cluster.metrics.projected_gdp_impact || cluster.metrics.gdp_impact) || 0;
              jobs = Number(cluster.metrics.projected_jobs || cluster.metrics.job_creation) || 0;
            }
            if (!gdp) {
              gdp = Number(cluster.projected_gdp_impact || cluster.gdp_impact) || 0;
              jobs = Number(cluster.projected_jobs || cluster.job_creation) || 0;
            }
            console.log(`${idx + 1}. ${cluster.name}`);
            console.log(`   - Type: ${cluster.type || 'mixed'}`);
            console.log(`   - Businesses: ${cluster.business_count || (cluster.businesses?.length || 0)}`);
            console.log(`   - GDP Impact: $${(gdp / 1e9).toFixed(2)}B`);
            console.log(`   - Jobs: ${Number.isFinite(jobs) ? jobs : 0}`);
          });
        }
        // Display natural communities if available
        if (results.steps.cluster_optimization && results.steps.cluster_optimization.natural_communities_details) {
          displayNaturalCommunities(results.steps.cluster_optimization.natural_communities_details);
        }
        
        // Store cluster data globally for filtering
        window.clusterData = clusters;
        
        // Initialize cluster filters
        initializeClusterFilters(clusters);
        
        displayClusterDetails(clusters);
        
        // Initialize cluster filters function
        function initializeClusterFilters(clusters) {
          console.log('Initializing cluster filters for', clusters.length, 'clusters');
          
          // Calculate min/max values for sliders
          let minGDP = Infinity, maxGDP = -Infinity;
          let minJobs = Infinity, maxJobs = -Infinity;
          const clusterTypes = new Set();
          
          clusters.forEach(cluster => {
            const gdp = cluster.gdp_impact || cluster.projected_gdp_impact || 0;
            const jobs = cluster.job_creation || cluster.projected_jobs || 0;
            const type = cluster.type || 'unknown';
            
            minGDP = Math.min(minGDP, gdp);
            maxGDP = Math.max(maxGDP, gdp);
            minJobs = Math.min(minJobs, jobs);
            maxJobs = Math.max(maxJobs, jobs);
            clusterTypes.add(type);
          });
          
          // Create filter controls if they don't exist
          if ($('#clusterFiltersContainer').length === 0) {
            const filterHtml = `
              <div id="clusterFiltersContainer" class="card mb-3">
                <div class="card-header">
                  <h5><i class="fas fa-filter"></i> Cluster Filters</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label for="minGDPFilter" class="form-label">Min GDP Impact ($B)</label>
                      <input type="number" class="form-control" id="minGDPFilter"
                             value="${(minGDP / 1e9).toFixed(1)}" step="0.1" min="0">
                    </div>
                    <div class="col-md-3">
                      <label for="maxGDPFilter" class="form-label">Max GDP Impact ($B)</label>
                      <input type="number" class="form-control" id="maxGDPFilter"
                             value="${(maxGDP / 1e9).toFixed(1)}" step="0.1" min="0">
                    </div>
                    <div class="col-md-3">
                      <label for="minJobsFilter" class="form-label">Min Jobs</label>
                      <input type="number" class="form-control" id="minJobsFilter"
                             value="${minJobs}" step="100" min="0">
                    </div>
                    <div class="col-md-3">
                      <label for="maxJobsFilter" class="form-label">Max Jobs</label>
                      <input type="number" class="form-control" id="maxJobsFilter"
                             value="${maxJobs}" step="100" min="0">
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label for="clusterTypeFilter" class="form-label">Cluster Types</label>
                      <select class="form-select" id="clusterTypeFilter" multiple>
                        ${Array.from(clusterTypes).map(type =>
                          `<option value="${type}" selected>${type}</option>`
                        ).join('')}
                      </select>
                      <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple types</small>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">&nbsp;</label>
                      <div>
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                          <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                          <i class="fas fa-undo"></i> Reset
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            // Insert filters before cluster details
            $('#clusterDetailsSection').prepend(filterHtml);
          }
          
          // Add reset filters function
          window.resetFilters = function() {
            $('#minGDPFilter').val((minGDP / 1e9).toFixed(1));
            $('#maxGDPFilter').val((maxGDP / 1e9).toFixed(1));
            $('#minJobsFilter').val(minJobs);
            $('#maxJobsFilter').val(maxJobs);
            $('#clusterTypeFilter option').prop('selected', true);
            applyFilters();
          };
        }
        
        // Display ML-specific visualizations
        if (visualizations && visualizations.ml_predictions_chart) {
          try {
            const mlPredData = JSON.parse(visualizations.ml_predictions_chart);
            Plotly.newPlot("mlPredictionsChart", mlPredData.data, mlPredData.layout);
          } catch (e) {
            console.error("Error rendering ML predictions chart:", e);
          }
        }
        
        if (visualizations && visualizations.confidence_chart) {
          try {
            const confData = JSON.parse(visualizations.confidence_chart);
            Plotly.newPlot("confidenceChart", confData.data, confData.layout);
          } catch (e) {
            console.error("Error rendering confidence chart:", e);
          }
        }
        
        if (visualizations && visualizations.network_graph) {
          try {
            const netData = JSON.parse(visualizations.network_graph);
            Plotly.newPlot("networkGraph", netData.data, netData.layout);
          } catch (e) {
            console.error("Error rendering network graph:", e);
          }
        }
        
        if (visualizations && visualizations.feature_importance_chart) {
          try {
            const featData = JSON.parse(visualizations.feature_importance_chart);
            Plotly.newPlot("featureImportanceChart", featData.data, featData.layout);
          } catch (e) {
            console.error("Error rendering feature importance chart:", e);
          }
        }
        
        if (visualizations && visualizations.synergy_heatmap) {
          try {
            const synData = JSON.parse(visualizations.synergy_heatmap);
            Plotly.newPlot("synergyHeatmap", synData.data, synData.layout);
            
            // Add synergy insights below heatmap
            displaySynergyInsights(clusters);
          } catch (e) {
            console.error("Error rendering synergy heatmap:", e);
          }
        }
        
        if (visualizations && visualizations.prediction_intervals_chart) {
          try {
            const intData = JSON.parse(visualizations.prediction_intervals_chart);
            Plotly.newPlot("predictionIntervalsChart", intData.data, intData.layout);
          } catch (e) {
            console.error("Error rendering prediction intervals chart:", e);
          }
        }

        // Display ML insights if available
        console.log("Checking for ML explanations...");
        console.log("results.ml_explanations exists?", !!results.ml_explanations);
        console.log("ML explanations content:", results.ml_explanations);
        
        if (results.ml_explanations) {
          console.log("Calling displayMLInsights with:", results.ml_explanations);
          
          // Get clusters from various possible locations
          let clusters = null;
          if (results.steps && results.steps.cluster_optimization && results.steps.cluster_optimization.clusters) {
            clusters = results.steps.cluster_optimization.clusters;
            console.log("Found clusters in steps.cluster_optimization");
          } else if (results.clusters) {
            clusters = results.clusters;
            console.log("Found clusters in results.clusters");
          } else {
            console.warn("No clusters found for ML insights");
          }
          
          try {
            displayMLInsights(results.ml_explanations, clusters);
            console.log("displayMLInsights completed");
          } catch (e) {
            console.error("Error in displayMLInsights:", e);
          }
        } else {
          console.log("No ML explanations found in results");
        }
        
        // Display SBIR analysis if available and has real data
        if (results.sbir_analysis && results.sbir_analysis.total_awards > 0) {
          // Check if clusters actually have SBIR funding
          let hasRealData = false;
          if (results.sbir_analysis.by_cluster) {
            for (const cluster in results.sbir_analysis.by_cluster) {
              if (results.sbir_analysis.by_cluster[cluster].awards > 0) {
                hasRealData = true;
                break;
              }
            }
          }
          
          // Only display if there's actual SBIR data
          if (hasRealData) {
            displaySBIRAnalysis(results.sbir_analysis);
          }
        }

        // Display market monitoring data if available
        console.log("Checking for market data...");
        if (results.market_analysis) {
          console.log("Found market_analysis:", results.market_analysis);
          // Map backend field names to frontend expected names
          const marketData = {
            economic_indicators: results.market_analysis.economic_indicators || {},
            commodity_prices: results.market_analysis.commodity_prices || {},
            market_scores: results.market_analysis.market_scores || results.market_analysis.market_favorability || {},
            insights: results.market_analysis.insights || results.market_analysis.market_insights || []
          };
          console.log("Prepared marketData:", marketData);
          try {
            displayMarketMonitoring(marketData);
            console.log("displayMarketMonitoring completed");
          } catch (e) {
            console.error("Error in displayMarketMonitoring:", e);
          }
        } else if (
          results.steps &&
          results.steps.data_collection &&
          results.steps.data_collection.market_data
        ) {
          console.log("Found market data in steps:", results.steps.data_collection.market_data);
          displayMarketMonitoring(results.steps.data_collection.market_data);
        } else {
          console.log("No market data found");
        }

        // Display recommendations
        console.log("Checking for recommendations...");
        console.log("results.steps exists?", !!results.steps);
        console.log("results.steps.recommendations exists?", !!(results.steps && results.steps.recommendations));
        
        if (results.steps && results.steps.recommendations) {
          const recs = results.steps.recommendations;
          console.log("Found recommendations:", recs);
          
          try {
            // Entrepreneur recommendations
            let entrepreneurHtml = "";
            if (recs.entrepreneurs && recs.entrepreneurs.length > 0) {
            recs.entrepreneurs.slice(0, 3).forEach((rec) => {
          entrepreneurHtml += `
                    <div class="recommendation-card">
                        <h6>${rec.opportunity}</h6>
                        <p>${rec.rationale}</p>
                        <small>Investment: ${rec.investment_range}</small>
                    </div>`;
            });
          } else {
            entrepreneurHtml = '<p class="text-muted">No entrepreneur recommendations available.</p>';
          }
          $("#entrepreneurRecs").html(entrepreneurHtml);

          // Investor recommendations
          let investorHtml = "";
          if (recs.investors && recs.investors.length > 0) {
            recs.investors.slice(0, 3).forEach((rec) => {
          investorHtml += `
                    <div class="recommendation-card">
                        <h6>${rec.cluster}</h6>
                        <p>ROI: ${rec.projected_roi} | Risk: ${rec.risk_level}</p>
                        <small>${rec.investment_thesis}</small>
                    </div>`;
            });
          } else {
            investorHtml = '<p class="text-muted">No investor recommendations available.</p>';
          }
          $("#investorRecs").html(investorHtml);

          // University recommendations
          let universityHtml = "";
          if (recs.universities && recs.universities.length > 0) {
            recs.universities.slice(0, 3).forEach((rec) => {
          universityHtml += `
                    <div class="recommendation-card">
                        <h6>${rec.research_area}</h6>
                        <p>Funding: ${rec.funding_sources.join(", ")}</p>
                    </div>`;
            });
          } else {
            universityHtml = '<p class="text-muted">No university recommendations available.</p>';
          }
          $("#universityRecs").html(universityHtml);

          // Policymaker recommendations
          let policyHtml = "";
          if (recs.policymakers && recs.policymakers.length > 0) {
            recs.policymakers.slice(0, 3).forEach((rec) => {
          policyHtml += `
                    <div class="recommendation-card">
                        <h6>${rec.action}</h6>
                        <p>${rec.impact}</p>
                        <small>Priority: ${rec.priority} | Timeline: ${rec.timeline}</small>
                    </div>`;
            });
          } else {
            policyHtml = '<p class="text-muted">No policy recommendations available.</p>';
          }
          $("#policyRecs").html(policyHtml);
            console.log("All recommendations displayed successfully");
          } catch (e) {
            console.error("Error displaying recommendations:", e);
          }
        } else {
          // No recommendations available at all
          console.log("No recommendations found, showing default messages");
          $("#entrepreneurRecs").html('<p class="text-muted">No recommendations data available.</p>');
          $("#investorRecs").html('<p class="text-muted">No recommendations data available.</p>');
          $("#universityRecs").html('<p class="text-muted">No recommendations data available.</p>');
          $("#policyRecs").html('<p class="text-muted">No recommendations data available.</p>');
        }

        // Generate and display report
        generateReport();
        
        // Diagnostic: Check if sections are visible
        setTimeout(function() {
          console.log("\n=== SECTION VISIBILITY CHECK ===");
          console.log("ML Insights Section visible?", $("#mlInsightsSection").is(":visible"));
          console.log("ML Insights List content:", $("#mlInsightsList").html()?.substring(0, 100) + "...");
          console.log("Market Monitoring Section visible?", $("#marketMonitoringSection").is(":visible"));
          console.log("Market Scores List content:", $("#marketScoresList").html()?.substring(0, 100) + "...");
          console.log("Recommendations Section visible?", $("#recommendationsSection").is(":visible"));
          console.log("Entrepreneur Recs content:", $("#entrepreneurRecs").html()?.substring(0, 100) + "...");
        }, 1000);
      }

      function displayNaturalCommunities(communities) {
        console.log("Displaying natural communities:", communities.length, "communities");
        let html = "";

        if (!communities || communities.length === 0) {
          html = '<p class="text-muted">No natural community details available.</p>';
          $("#naturalCommunitiesList").html(html);
          return;
        }

        // Create accordion container for proper collapse behavior
        html = '<div class="accordion" id="naturalCommunitiesAccordion">';

        // Create expandable cards for each community
        communities.forEach((community, index) => {
          const collapseId = `community-${index}`;
          const headingId = `heading-${index}`;
          
          html += `
            <div class="card mb-2 community-card">
              <div class="card-header community-header" id="${headingId}">
                <h5 class="mb-0 d-flex justify-content-between align-items-center" 
                    style="cursor: pointer;" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#${collapseId}" 
                    aria-expanded="false" 
                    aria-controls="${collapseId}">
                  <span>
                    <i class="fas fa-users mr-2"></i>${community.name}
                  </span>
                  <span class="d-flex align-items-center">
                    <span class="badge badge-primary mr-3" style="color: #212529; background-color: #cfe2ff; border-color: #b6d4fe;">${community.business_count} businesses</span>
                    <i class="fas fa-chevron-down collapse-indicator" style="transition: transform 0.3s ease;"></i>
                  </span>
                </h5>
              </div>
              <div id="${collapseId}" 
                   class="collapse" 
                   aria-labelledby="${headingId}" 
                   data-bs-parent="#naturalCommunitiesAccordion">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Community Profile:</h6>
                      <ul class="list-unstyled">
                        <li><strong>Location:</strong> ${community.county}</li>
                        <li><strong>Average Business Size:</strong> ${community.avg_employees} employees</li>
                        <li><strong>Average Business Age:</strong> ${community.avg_business_age} years</li>
                        <li><strong>Total Revenue:</strong> $${(community.total_revenue / 1e6).toFixed(1)}M</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <h6>Primary Industries:</h6>
                      <ul class="list-unstyled">
                        ${community.primary_industries.map(ind => `<li>${ind}</li>`).join('')}
                      </ul>
                    </div>
                  </div>
                  
                  <h6 class="mt-3">Size Distribution:</h6>
                  <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-info" style="width: ${(community.size_distribution.small / community.business_count) * 100}%">
                      Small (${community.size_distribution.small})
                    </div>
                    <div class="progress-bar bg-primary" style="width: ${(community.size_distribution.medium / community.business_count) * 100}%">
                      Medium (${community.size_distribution.medium})
                    </div>
                    <div class="progress-bar bg-success" style="width: ${(community.size_distribution.large / community.business_count) * 100}%">
                      Large (${community.size_distribution.large})
                    </div>
                  </div>
                  
                  <h6>Why Grouped Together:</h6>
                  <ul>
                    ${community.grouping_reasons.map(reason => `<li>${reason}</li>`).join('')}
                  </ul>
                  
                  ${community.top_businesses && community.top_businesses.length > 0 ? `
                    <h6 class="mt-3">Top Businesses:</h6>
                    <ul>
                      ${community.top_businesses.map(biz => 
                        `<li>${biz.name} (${biz.employees} employees)</li>`
                      ).join('')}
                    </ul>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        });

        // Close accordion container
        html += '</div>';

        $("#naturalCommunitiesList").html(html);
        
        // Add event listeners for chevron rotation and ensure proper Bootstrap 5 initialization
        const accordionEl = document.getElementById('naturalCommunitiesAccordion');
        if (accordionEl) {
          accordionEl.addEventListener('show.bs.collapse', function (e) {
            const header = e.target.previousElementSibling;
            if (header) {
              const indicator = header.querySelector('.collapse-indicator');
              if (indicator) {
                indicator.style.transform = 'rotate(180deg)';
              }
            }
          });
          
          accordionEl.addEventListener('hide.bs.collapse', function (e) {
            const header = e.target.previousElementSibling;
            if (header) {
              const indicator = header.querySelector('.collapse-indicator');
              if (indicator) {
                indicator.style.transform = 'rotate(0deg)';
              }
            }
          });
        }
      }

      function displaySynergyInsights(clusters) {
        // Display key insights about cluster synergies
        let html = '<div class="alert alert-info">';
        html += '<h6><i class="fas fa-lightbulb"></i> Synergy Insights</h6>';
        html += '<ul class="mb-0">';
        
        // Find highest synergy pairs
        let highSynergies = [];
        let strongSupplyChains = [];
        
        // This is simplified - in production would analyze the actual synergy matrix
        html += '<li><strong>Strong Synergies (70+):</strong> Clusters with complete ecosystems and complementary capabilities</li>';
        html += '<li><strong>Supply Chain Opportunities:</strong> Look for vertical integration between manufacturing and logistics clusters</li>';
        html += '<li><strong>Geographic Advantages:</strong> Same-county clusters can share infrastructure and workforce</li>';
        html += '<li><strong>Innovation Potential:</strong> High-tech clusters can cross-pollinate with traditional industries</li>';
        html += '</ul>';
        html += '</div>';
        
        $("#synergyRecommendations").html(html);
      }
      
      function displayClusterDetails(clusters) {
        console.log("Displaying cluster details for", clusters.length, "clusters");
        console.log("Cluster data:", JSON.parse(JSON.stringify(clusters)));
        let html = "";

        // Display ALL dynamically discovered clusters
        if (clusters.length > 5) {
          html += `<div class="alert alert-info mb-3">
            <i class="fas fa-chart-network"></i> Discovered ${clusters.length} viable economic clusters through natural community analysis
          </div>`;
        }
        
        clusters.forEach((cluster, index) => {
          // Add visual separator every 3 clusters for better readability
          if (index > 0 && index % 3 === 0) {
            html += '<hr class="my-4" style="border-color: #e0e0e0;">';
          }
          
          // Handle both cluster formats with better error handling
          // Priority: ML predictions → metrics object → direct properties
          let gdpImpact = 0;
          let totalJobs = 0;
          let riskScore = 50; // Default medium risk
          
          // First try ML predictions (most reliable when ML enhancement is enabled)
          if (cluster.ml_predictions) {
            gdpImpact = cluster.ml_predictions.gdp_impact || 0;
            totalJobs = cluster.ml_predictions.job_creation || 0;
          }
          
          // Fallback to metrics object if ML predictions not available or zero
          if (!gdpImpact && cluster.metrics) {
            gdpImpact = cluster.metrics.projected_gdp_impact || cluster.metrics.gdp_impact || 0;
            totalJobs = cluster.metrics.projected_jobs || cluster.metrics.job_creation || 0;
            riskScore = cluster.metrics.risk_score || 50;
          }
          
          // Last fallback to direct cluster properties
          if (!gdpImpact) {
            gdpImpact = cluster.projected_gdp_impact || cluster.gdp_impact || 0;
            totalJobs = cluster.projected_jobs || cluster.job_creation || 0;
            riskScore = cluster.risk_score || 50;
          }
          
          // Validate numeric values
          gdpImpact = isNaN(gdpImpact) ? 0 : gdpImpact;
          totalJobs = isNaN(totalJobs) ? 0 : totalJobs;
          riskScore = isNaN(riskScore) ? 50 : riskScore;
          
          // Validate coordinates if available
          let validCoords = { lat: 39.0997, lng: -94.5786 }; // Default KC coordinates
          if (cluster.coordinates &&
              typeof cluster.coordinates.lat === 'number' &&
              !isNaN(cluster.coordinates.lat) &&
              typeof cluster.coordinates.lng === 'number' &&
              !isNaN(cluster.coordinates.lng) &&
              isFinite(cluster.coordinates.lat) &&
              isFinite(cluster.coordinates.lng)) {
            validCoords = cluster.coordinates;
          }

          html += `
                    <div class="cluster-detail-card" data-gdp="${gdpImpact}" data-jobs="${totalJobs}" data-type="${cluster.type || 'mixed'}">
                        <h5>${index + 1}. ${cluster.name}</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Type:</strong> ${
                                  cluster.type || "mixed"
                                }</p>
                                <p><strong>Strategic Score:</strong> ${
                                  Math.round(cluster.cluster_score ||
                                  cluster.total_score ||
                                  0)
                                }/100</p>
                                <p><strong>Businesses:</strong> ${
                                  cluster.business_count || cluster.businesses?.length || 0
                                }</p>
                                <p><strong>GDP Impact:</strong> ${formatCurrency(gdpImpact)}</p>
                                <p><strong>Jobs:</strong> ${!isNaN(totalJobs) ? totalJobs.toLocaleString() : 'N/A'}</p>
                                <input type="hidden" class="cluster-coords" data-lat="${validCoords.lat}" data-lng="${validCoords.lng}">
                                <p><strong>Risk Level:</strong> ${
                                  riskScore < 30
                                    ? "Low"
                                    : riskScore < 60
                                    ? "Medium"
                                    : "High"
                                }</p>
                                ${cluster.critical_mass ? `<p><strong>Critical Mass:</strong> ${Math.round(cluster.critical_mass)}/100 <i class="fas fa-info-circle text-muted" title="Ecosystem completeness - higher scores indicate more sustainable clusters"></i></p>` : ''}
                                ${cluster.sustainability_score ? `<p><strong>Sustainability Score:</strong> ${(cluster.sustainability_score * 100).toFixed(0)}% <i class="fas fa-leaf text-success" title="Long-term viability prediction based on Critical Mass and ecosystem factors"></i></p>` : ''}
                                ${displayLongevityScore(cluster, clusters)}
                            </div>
                            <div class="col-md-6">`;

          // Add ML predictions if available
          if (cluster.ml_predictions) {
            const ml = cluster.ml_predictions;
            // Determine ROI value: prefer normalized expected_roi; fallback to roi_percentage (percent)
            let roiDisplayPct = 0;
            if (ml && ml.expected_roi != null && !isNaN(ml.expected_roi)) {
              roiDisplayPct = ml.expected_roi * 100; // expected_roi is a fraction
            } else if (ml && ml.roi_percentage != null && !isNaN(ml.roi_percentage)) {
              roiDisplayPct = ml.roi_percentage; // already percent
            }
            const confidence = cluster.confidence_score || 0;
            html += `
                                <div class="ml-predictions">
                                    <h6>ML Enhancement <span class="badge bg-info">${(
                                      confidence * 100
                                    ).toFixed(0)}% confidence</span></h6>
                                    <p><strong>Predicted GDP:</strong> ${formatCurrency(
                                      ml.gdp_impact || 0
                                    )}</p>
                                    <p><strong>Predicted Jobs:</strong> ${(
                                      ml.job_creation || 0
                                    ).toLocaleString()}</p>
                                    <p><strong>Expected ROI:</strong> ${(
                                      roiDisplayPct
                                    ).toFixed(1)}%</p>
                                </div>`;
          }

          // Add network metrics if available
          if (cluster.network_metrics) {
            const network = cluster.network_metrics;
            html += `
                                <div class="network-metrics">
                                    <h6>Network Analysis</h6>
                                    <p><strong>Density:</strong> ${network.network_density.toFixed(
                                      2
                                    )}</p>
                                    <p><strong>Synergy Score:</strong> ${network.synergy_score.toFixed(
                                      1
                                    )}/100</p>
                                    <p><strong>Central Businesses:</strong> ${
                                      network.central_businesses.length
                                    }</p>
                                </div>`;
          }
          
          // Add enhanced analysis metrics if available
          if (cluster.workforce_analysis || cluster.market_analysis || cluster.patent_analysis || cluster.university_integration) {
            html += `
                                <div class="enhanced-metrics">
                                    <h6>Enhanced Analysis</h6>`;
            
            // Workforce Analysis
            if (cluster.workforce_analysis) {
              if (cluster.workforce_analysis.current_workforce) {
                html += `<p><strong>Current Workforce:</strong> ${cluster.workforce_analysis.current_workforce.toLocaleString()}</p>`;
              }
              if (cluster.workforce_analysis.projected_needs && cluster.workforce_analysis.projected_needs.total_jobs) {
                html += `<p><strong>5yr Workforce Need:</strong> ${cluster.workforce_analysis.projected_needs.total_jobs.toLocaleString()}</p>`;
              }
              if (cluster.workforce_analysis.skill_gaps && cluster.workforce_analysis.skill_gaps.length > 0) {
                html += `<p><strong>Key Skill Gaps:</strong> ${cluster.workforce_analysis.skill_gaps.slice(0, 2).join(', ')}</p>`;
              }
            }
            
            // Innovation Metrics
            if (cluster.patent_analysis) {
              if (cluster.patent_analysis.innovation_score) {
                html += `<p><strong>Innovation Score:</strong> ${cluster.patent_analysis.innovation_score.toFixed(1)}/100</p>`;
              }
              if (cluster.patent_analysis.patent_count) {
                html += `<p><strong>Patents:</strong> ${cluster.patent_analysis.patent_count}</p>`;
              }
              if (cluster.patent_analysis.emerging_technologies && cluster.patent_analysis.emerging_technologies.length > 0) {
                html += `<p><strong>Emerging Tech:</strong> ${cluster.patent_analysis.emerging_technologies.slice(0, 2).join(', ')}</p>`;
              }
            }
            
            // Market Analysis
            if (cluster.market_analysis) {
              if (cluster.market_analysis.market_opportunity_score) {
                html += `<p><strong>Market Opportunity:</strong> ${cluster.market_analysis.market_opportunity_score.toFixed(1)}/100</p>`;
              }
              if (cluster.market_analysis.market_size) {
                html += `<p><strong>Market Size:</strong> $${(cluster.market_analysis.market_size / 1e9).toFixed(1)}B</p>`;
              }
              if (cluster.market_analysis.growth_rate) {
                html += `<p><strong>Market Growth:</strong> ${(cluster.market_analysis.growth_rate * 100).toFixed(1)}%</p>`;
              }
            }
            
            // University Integration
            if (cluster.university_integration) {
              if (cluster.university_integration.impact_score) {
                html += `<p><strong>University Impact:</strong> ${cluster.university_integration.impact_score.toFixed(1)}/100</p>`;
              }
              if (cluster.university_integration.talent_pipeline) {
                html += `<p><strong>Graduate Pipeline:</strong> ${cluster.university_integration.talent_pipeline}/yr</p>`;
              }
            }
            
            // Revenue Projections
            if (cluster.revenue_projections && cluster.revenue_projections.growth_metrics) {
              const metrics = cluster.revenue_projections.growth_metrics;
              if (metrics.cagr) {
                html += `<p><strong>Revenue CAGR:</strong> ${metrics.cagr.toFixed(1)}%</p>`;
              }
              if (metrics.revenue_potential) {
                html += `<p><strong>5yr Revenue Potential:</strong> $${(metrics.revenue_potential / 1e6).toFixed(1)}M</p>`;
              }
              if (metrics.job_creation) {
                html += `<p><strong>New Jobs (5yr):</strong> +${metrics.job_creation.toLocaleString()}</p>`;
              }
            }
            
            // Longevity Assessment
            if (cluster.longevity_assessment) {
              if (cluster.longevity_assessment.key_risks && cluster.longevity_assessment.key_risks.length > 0) {
                const topRisk = cluster.longevity_assessment.key_risks[0];
                html += `<p><strong>Primary Risk:</strong> ${topRisk.category} (${topRisk.severity})</p>`;
              }
              if (cluster.longevity_assessment.mitigation_strategies && cluster.longevity_assessment.mitigation_strategies.length > 0) {
                html += `<p><strong>Risk Mitigation:</strong> ${cluster.longevity_assessment.mitigation_strategies.length} strategies identified</p>`;
              }
            }
            
            html += `</div>`;
          }

          html += `
                            </div>
                        </div>
                    </div>
                    <hr>`;
        });

        $("#clusterDetailsList").html(html);
        
        // Store cluster data for filtering
        window.clusterData = clusters.map(cluster => {
          // Extract GDP and jobs values from different possible locations
          let gdpImpact = 0;
          let totalJobs = 0;
          
          if (cluster.metrics) {
            gdpImpact = cluster.metrics.projected_gdp_impact || cluster.metrics.gdp_impact || 0;
            totalJobs = cluster.metrics.projected_jobs || cluster.metrics.job_creation || 0;
          } else {
            gdpImpact = cluster.projected_gdp_impact || cluster.gdp_impact || 0;
            totalJobs = cluster.projected_jobs || cluster.job_creation || 0;
          }
          
          // Validate coordinates
          let validCoords = { lat: 39.0997, lng: -94.5786 }; // Default KC coordinates
          if (cluster.coordinates &&
              typeof cluster.coordinates.lat === 'number' &&
              !isNaN(cluster.coordinates.lat) &&
              typeof cluster.coordinates.lng === 'number' &&
              !isNaN(cluster.coordinates.lng) &&
              isFinite(cluster.coordinates.lat) &&
              isFinite(cluster.coordinates.lng)) {
            validCoords = cluster.coordinates;
          }
          
          return {
            ...cluster,
            gdp_impact: gdpImpact,
            job_creation: totalJobs,
            coordinates: validCoords
          };
        });
        
        // Initialize cluster filters if not already done
        // Avoid creating duplicate filter panels by checking for either
        // the legacy '#clusterFilterCard' or the dynamic '#clusterFiltersContainer'.
        if (!$('#clusterFilterCard').length && !$('#clusterFiltersContainer').length) {
          if (typeof window.initializeClusterFilters === 'function') {
            window.initializeClusterFilters();
          }
        }
        
        console.log('Stored cluster data for filtering:', window.clusterData.length, 'clusters');
      }

      function displayMLInsights(mlExplanations, clusters) {
        console.log("displayMLInsights called with:", mlExplanations, clusters);
        console.log("mlInsightsList element exists?", $("#mlInsightsList").length > 0);
        
        if (!mlExplanations && !clusters) {
          console.log("No ML explanations or clusters, showing default message");
          $("#mlInsightsList").html('<p class="text-muted">No ML insights available. Enable ML enhancement in analysis parameters to get predictive insights.</p>');
          return;
        }
        
        let html =
          '<p class="text-muted">The ML enhancement provides data-driven predictions based on historical cluster performance:</p>';

        // Display overall ML insights
        if (clusters && clusters.length > 0) {
          // Count clusters with high confidence
          const highConfidenceClusters = clusters.filter(c => 
            c.confidence_score && c.confidence_score >= 0.8
          ).length;
          
          const avgConfidence = clusters.reduce((sum, c) => 
            sum + (c.confidence_score || 0), 0
          ) / clusters.length * 100;
          
          // Check if enhanced models were used
          const enhancedModels = $("#mlEnhancement").val() === "enhanced";
          const modelType = enhancedModels ? 
            '<span class="badge bg-success ms-2">Enhanced KC Models (18 features)</span>' : 
            '<span class="badge bg-secondary ms-2">Standard Models (13 features)</span>';
          
          html += `
            <div class="alert alert-info">
              <h6>ML Analysis Summary ${modelType}</h6>
              <ul class="mb-0">
                <li><strong>${highConfidenceClusters}</strong> clusters with high confidence predictions (&gt;80%)</li>
                <li>Average prediction confidence: <strong>${avgConfidence.toFixed(1)}%</strong></li>
                ${enhancedModels ? '<li>Using KC Open Data for 1.2% better ROI accuracy</li>' : ''}
                <li>Network analysis completed for top clusters</li>
                <li>Synergy opportunities identified across cluster types</li>
              </ul>
            </div>
          `;
        }

        // Display cluster-specific explanations
        Object.entries(mlExplanations || {})
          .slice(0, 3)
          .forEach(([clusterName, explanation]) => {
            html += `
                    <div class="ml-insight-card">
                        <h5>${clusterName}</h5>`;

            if (explanation.key_drivers && explanation.key_drivers.length > 0) {
              html += "<h6>Key Success Drivers:</h6><ul>";
              explanation.key_drivers.slice(0, 5).forEach((driver) => {
                html += `<li>${driver}</li>`;
              });
              html += "</ul>";
            }

            if (explanation.recommendations && explanation.recommendations.length > 0) {
              html += "<h6>ML Recommendations:</h6><ul>";
              explanation.recommendations.slice(0, 3).forEach((rec) => {
                html += `<li>${rec}</li>`;
              });
              html += "</ul>";
            }

            html += "</div><hr>";
          });

        console.log("Setting ML insights HTML, length:", html.length);
        $("#mlInsightsList").html(html);
        console.log("ML insights HTML set. Final content length:", $("#mlInsightsList").html().length);
      }
      
      function displaySBIRAnalysis(sbirData) {
        if (!sbirData) return;
        
        console.log("Displaying SBIR analysis:", sbirData);
        
        // Update SBIR metrics if elements exist
        if ($("#sbirTotalAwards").length) {
          $("#sbirTotalAwards").text(sbirData.total_awards || 0);
          $("#sbirTotalFunding").text(formatCurrency(sbirData.total_funding || 0));
        } else {
          // Create SBIR section if it doesn't exist
          let sbirHtml = `
            <div class="card mt-4">
              <div class="card-header">
                <h4>SBIR/STTR Innovation Funding Analysis</h4>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="metric-card">
                      <h5>Total Awards</h5>
                      <p class="metric-value">${sbirData.total_awards || 0}</p>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="metric-card">
                      <h5>Total Funding</h5>
                      <p class="metric-value">${formatCurrency(sbirData.total_funding || 0)}</p>
                    </div>
                  </div>
                </div>
                <div id="sbirByClusterChart" class="mt-3"></div>
              </div>
            </div>
          `;
          
          // Insert after ML insights section
          $("#mlInsightsSection").after(sbirHtml);
        }
        
        // Create SBIR by cluster chart if data available
        if (sbirData.by_cluster) {
          const chartData = [{
            x: Object.keys(sbirData.by_cluster),
            y: Object.values(sbirData.by_cluster).map(c => c.funding || 0),
            type: 'bar',
            name: 'SBIR/STTR Funding',
            marker: { color: 'rgb(76, 175, 80)' },
            text: Object.values(sbirData.by_cluster).map(c => 
              `Awards: ${c.awards || 0}<br>Avg: ${formatCurrency(c.average_award || 0)}`
            ),
            hovertemplate: '%{x}<br>Total: %{y}<br>%{text}<extra></extra>'
          }];
          
          const layout = {
            title: 'SBIR/STTR Funding Distribution by Cluster',
            xaxis: { title: 'Cluster' },
            yaxis: { 
              title: 'Total Funding ($)',
              tickformat: ',.0f'
            },
            height: 400
          };
          
          Plotly.newPlot('sbirByClusterChart', chartData, layout);
        }
      }

      function displayMarketMonitoring(marketData) {
        console.log("displayMarketMonitoring called with:", marketData);
        console.log("Market monitoring elements exist?");
        console.log("- economicIndicatorsList:", $("#economicIndicatorsList").length > 0);
        console.log("- commodityPricesList:", $("#commodityPricesList").length > 0);
        console.log("- marketScoresList:", $("#marketScoresList").length > 0);
        
        if (!marketData) {
          console.log("No market data provided");
          $("#economicIndicatorsList").html('<p class="text-muted">No economic indicators available.</p>');
          $("#commodityPricesList").html('<p class="text-muted">No commodity prices available.</p>');
          $("#marketScoresList").html('<p class="text-muted">No market scores available.</p>');
          return;
        }

        // Display economic indicators
        if (marketData.economic_indicators && Object.keys(marketData.economic_indicators).length > 0) {
          let html = '<ul class="list-unstyled">';
          Object.entries(marketData.economic_indicators).forEach(
            ([key, data]) => {
              const label = key
                .replace(/_/g, " ")
                .replace(/\b\w/g, (l) => l.toUpperCase());
              let value = data.value;
              let unit = "";

              // Format based on indicator type
              if (
                key === "gdp_growth" ||
                key === "inflation" ||
                key === "unemployment" ||
                key === "interest_rate"
              ) {
                value = value.toFixed(2);
                unit = "%";
              } else if (key === "industrial_production") {
                value = value.toFixed(1);
                unit = " index";
              } else {
                value = value.toFixed(1);
              }

              html += `<li><strong>${label}:</strong> ${value}${unit} <small class="text-muted">(${data.date})</small></li>`;
            }
          );
          html += "</ul>";
          $("#economicIndicatorsList").html(html);
        } else {
          $("#economicIndicatorsList").html('<p class="text-muted">No economic indicators data available.</p>');
        }

        // Display commodity prices
        if (marketData.commodity_prices) {
          let html = '<ul class="list-unstyled">';
          Object.entries(marketData.commodity_prices).forEach(([key, data]) => {
            const label = key
              .replace(/_/g, " ")
              .replace(/\b\w/g, (l) => l.toUpperCase());
            let value = data.value;
            let prefix = "";

            // Format based on commodity type
            if (key === "electricity" && data.units === "cents/kWh") {
              value = value.toFixed(3);
              prefix = "";
            } else {
              value = value.toFixed(2);
              prefix = "$";
            }

            html += `<li><strong>${label}:</strong> ${prefix}${value} ${data.units} <small class="text-muted">(${data.date})</small></li>`;
          });
          html += "</ul>";
          $("#commodityPricesList").html(html);
        } else {
          $("#commodityPricesList").html('<p class="text-muted">No commodity prices data available.</p>');
        }

        // Display market scores
        if (marketData.market_scores) {
          // Check if all market scores are identical (placeholder data)
          const scores = Object.values(marketData.market_scores);
          const allSame = scores.length > 1 && scores.every(score => Math.abs(score - scores[0]) < 0.001);
          
          if (allSame) {
            // Don't display placeholder market scores
            $("#marketScoresList").html('<p class="text-muted"><i class="fas fa-info-circle"></i> Market analysis data is being processed. Check back later for real-time market conditions.</p>');
          } else {
            let html = '<div class="row">';
            Object.entries(marketData.market_scores).forEach(
              ([cluster, score]) => {
                const percentage = (score * 100).toFixed(0);
                const colorClass =
                  score > 0.6 ? "success" : score > 0.4 ? "warning" : "danger";
                html += `
                          <div class="col-md-3">
                              <div class="progress mb-2">
                                  <div class="progress-bar bg-${colorClass}" style="width: ${percentage}%">${cluster}: ${percentage}%</div>
                              </div>
                          </div>`;
              }
            );
            html += "</div>";
            $("#marketScoresList").html(html);
          }
        } else {
          $("#marketScoresList").html('<p class="text-muted">No market scores data available.</p>');
        }

        // Display market insights
        if (marketData.insights && marketData.insights.length > 0) {
          let html = "<ul>";
          marketData.insights.forEach((insight) => {
            html += `<li>${insight}</li>`;
          });
          html += "</ul>";
          $("#marketInsightsList").html(html);
        } else {
          $("#marketInsightsList").html('<p class="text-muted">No market insights available.</p>');
        }
      }

      function generateReport() {
        // For now, just display a summary
        const reportHtml = `
Analysis completed successfully!

Key Findings:
- Economic clusters identified using AI-powered optimization
- Multi-objective genetic algorithm (NSGA-II) applied
- Comprehensive scoring across innovation, market potential, and competition
- Recommendations generated for all stakeholder groups

For detailed analysis, export the full results using the buttons above.
            `;
        $("#reportContent").text(reportHtml);
      }

      function exportResults(format) {
        if (!currentAnalysisId) {
          alert("Please run an analysis first");
          return;
        }

        // Check if currentAnalysisId is a task_id (UUID format) or export_id
        const isTaskId = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(currentAnalysisId);
        
        if (isTaskId) {
          // Use the task_id endpoints for all export formats
          window.location.href = `/api/export/${format}/by_task/${currentAnalysisId}`;
        } else {
          // Use the standard export endpoint for export_id
          window.location.href = `/api/export/${format}/${currentAnalysisId}`;
        }
      }

      // Map visualization functions
      function showClusterMap() {
        if (!currentScenarioResults || !currentScenarioResults.visualizations) {
          alert("Please run an analysis first");
          return;
        }

        console.log("Current Analysis ID:", currentAnalysisId);
        console.log("Current Results:", currentScenarioResults);

        $("#mapContainer").show();
        
        // Helper to choose correct map endpoint for current ID
        const idIsTask = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(currentAnalysisId);
        const idIsExport = /^kc_analysis_\d{8}_\d{6}_[a-fA-F0-9]{8}$/.test(currentAnalysisId);
        const mapEndpoint = idIsExport
          ? `/api/map/by_export/${currentAnalysisId}`
          : `/api/map/${currentAnalysisId}`;

        // Check if cluster_map is available in visualizations
        if (currentScenarioResults.visualizations.cluster_map) {
          // The map HTML is already available in visualizations
          let mapHtml = currentScenarioResults.visualizations.cluster_map;
          // If the visualization contains an empty placeholder, fallback to server-side map endpoint
          if (typeof mapHtml === 'string' && mapHtml.indexOf('No geographic data available') !== -1) {
            console.warn('Client-side map HTML is a placeholder; falling back to /api/map');
            $("#mapContainer").html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading map...</div>');
            $.get(mapEndpoint)
              .done(function (response) {
                if (response.status === "success" && response.map_html) {
                  let srvHtml = response.map_html
                    .replace(/window\.tooltipData/g, 'mapTooltipData')
                    .replace(/window\.applyFilters/g, 'mapApplyFilters')
                    .replace(/window\.clusterData/g, 'mapClusterData');
                  const blob = new Blob([srvHtml], {type: 'text/html; charset=utf-8'});
                  const blobUrl = URL.createObjectURL(blob);
                  const iframe = $('<iframe>')
                    .attr('id', 'mapFrame')
                    .attr('src', blobUrl)
                    .attr('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms')
                    .css({ width: '100%', height: '100%', border: 'none' });
                  $("#mapContainer").empty().append(iframe);
                  iframe.on('load', function() { setTimeout(() => URL.revokeObjectURL(blobUrl), 1000); });
                } else {
                  $("#mapContainer").html('<div class="text-center text-muted">Failed to load map.</div>');
                }
              })
              .fail(function (xhr) {
                console.error('Map endpoint failed:', xhr && xhr.statusText);
                $("#mapContainer").html('<div class="text-center text-muted">Failed to load map.</div>');
              });
            return;
          }
          
          // Strip any references to parent page variables from the map HTML
          // This prevents scope conflicts in the iframe
          mapHtml = mapHtml.replace(/window\.tooltipData/g, 'mapTooltipData');
          mapHtml = mapHtml.replace(/window\.applyFilters/g, 'mapApplyFilters');
          mapHtml = mapHtml.replace(/window\.clusterData/g, 'mapClusterData');
          
          // Create isolated iframe using Blob URL for complete sandbox isolation
          const blob = new Blob([mapHtml], {type: 'text/html; charset=utf-8'});
          const blobUrl = URL.createObjectURL(blob);
          
          const iframe = $('<iframe>')
            .attr('id', 'mapFrame')
            .attr('src', blobUrl)
            .attr('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms')
            .css({
              width: '100%',
              height: '100%',
              border: 'none'
            });
          
          $("#mapContainer").empty().append(iframe);
          
          // Clean up blob URL after iframe loads
          iframe.on('load', function() {
            setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
          });
        } else {
          // Fallback to API endpoint if not in visualizations
          $("#mapContainer").html(
            '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading map...</div>'
          );

          $.get(mapEndpoint)
            .done(function (response) {
              if (response.status === "success") {
                // Strip parent page variable references
                let mapHtml = response.map_html;
                mapHtml = mapHtml.replace(/window\.tooltipData/g, 'mapTooltipData');
                mapHtml = mapHtml.replace(/window\.applyFilters/g, 'mapApplyFilters');
                mapHtml = mapHtml.replace(/window\.clusterData/g, 'mapClusterData');
                
                // Create isolated iframe using Blob URL
                const blob = new Blob([mapHtml], {type: 'text/html; charset=utf-8'});
                const blobUrl = URL.createObjectURL(blob);
                
                const iframe = $('<iframe>')
                  .attr('id', 'mapFrame')
                  .attr('src', blobUrl)
                  .attr('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms')
                  .css({
                    width: '100%',
                    height: '100%',
                    border: 'none'
                  });
                
                $("#mapContainer").empty().append(iframe);
                
                // Clean up blob URL after load
                iframe.on('load', function() {
                  setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
                });
              } else {
                alert("Error loading map: " + response.message);
              }
            })
            .fail(function () {
              alert("Failed to load map");
            });
        }
      }

      function showGrowthPotentialMap() {
        if (!currentScenarioResults || !currentScenarioResults.visualizations) {
          alert("Please run an analysis first");
          return;
        }

        $("#mapContainer").show();
        
        // Check if heat_map is available in visualizations (now Growth Potential Map)
        if (currentScenarioResults.visualizations.heat_map) {
          // The growth potential map HTML is already available in visualizations
          let growthMapHtml = currentScenarioResults.visualizations.heat_map;
          
          // Strip parent page variable references
          growthMapHtml = growthMapHtml.replace(/window\.tooltipData/g, 'mapTooltipData');
          growthMapHtml = growthMapHtml.replace(/window\.applyFilters/g, 'mapApplyFilters');
          growthMapHtml = growthMapHtml.replace(/window\.clusterData/g, 'mapClusterData');
          
          // Create isolated iframe using Blob URL
          const blob = new Blob([growthMapHtml], {type: 'text/html; charset=utf-8'});
          const blobUrl = URL.createObjectURL(blob);
          
          const iframe = $('<iframe>')
            .attr('id', 'heatMapFrame')
            .attr('src', blobUrl)
            .attr('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms')
            .css({
              width: '100%',
              height: '100%',
              border: 'none'
            });
          
          $("#mapContainer").empty().append(iframe);
          
          // Clean up blob URL after load
          iframe.on('load', function() {
            setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
          });
        } else {
          // No growth potential map available
          $("#mapContainer").html(
            '<div class="text-center text-muted"><i class="fas fa-exclamation-circle"></i> Growth potential map visualization not available</div>'
          );
        }
      }

      function showEconomicImpactMap() {
        if (!currentScenarioResults || !currentScenarioResults.visualizations) {
          alert("Please run an analysis first");
          return;
        }

        $("#mapContainer").show();
        
        // Check if economic_impact_map is available in visualizations
        if (currentScenarioResults.visualizations.economic_impact_map) {
          // The economic impact map HTML is already available in visualizations
          let economicMapHtml = currentScenarioResults.visualizations.economic_impact_map;
          
          // Strip parent page variable references
          economicMapHtml = economicMapHtml.replace(/window\.tooltipData/g, 'mapTooltipData');
          economicMapHtml = economicMapHtml.replace(/window\.applyFilters/g, 'mapApplyFilters');
          economicMapHtml = economicMapHtml.replace(/window\.clusterData/g, 'mapClusterData');
          
          // Create isolated iframe using Blob URL
          const blob = new Blob([economicMapHtml], {type: 'text/html; charset=utf-8'});
          const blobUrl = URL.createObjectURL(blob);
          
          const iframe = $('<iframe>')
            .attr('id', 'economicMapFrame')
            .attr('src', blobUrl)
            .attr('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms')
            .css({
              width: '100%',
              height: '100%',
              border: 'none'
            });
          
          $("#mapContainer").empty().append(iframe);
          
          // Clean up blob URL after load
          iframe.on('load', function() {
            setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
          });
        } else {
          // No economic impact map available
          $("#mapContainer").html(
            '<div class="text-center text-muted"><i class="fas fa-exclamation-circle"></i> Economic impact map visualization not available</div>'
          );
        }
      }

      // Scenario management functions
      let currentScenarioParams = null;
      let currentScenarioResults = null;
      let selectedScenarios = [];

      function saveCurrentScenario() {
        if (!currentAnalysisId || !currentScenarioResults) {
          alert("Please run an analysis first");
          return;
        }

        const scenarioName = prompt(
          "Enter a name for this scenario:",
          `Scenario ${new Date().toLocaleDateString()}`
        );

        if (!scenarioName) return;

        const data = {
          name: scenarioName,
          parameters: currentScenarioParams,
          results: currentScenarioResults,
        };

        $.ajax({
          url: "/api/scenarios/save",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function (response) {
            if (response.status === "success") {
              alert("Scenario saved successfully!");
              loadScenarios();
            } else {
              alert("Error saving scenario: " + response.message);
            }
          },
          error: function () {
            alert("Failed to save scenario");
          },
        });
      }

      function loadScenarios() {
        $("#scenarioList").show();
        $("#scenarioListContent").html(
          '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading scenarios...</div>'
        );

        $.get("/api/scenarios/list")
          .done(function (response) {
            if (response.status === "success") {
              displayScenarioList(response.scenarios);
            } else {
              alert("Error loading scenarios: " + response.message);
            }
          })
          .fail(function () {
            alert("Failed to load scenarios");
          });
      }

      function displayScenarioList(scenarios) {
        if (scenarios.length === 0) {
          $("#scenarioListContent").html(
            '<p class="text-muted">No saved scenarios</p>'
          );
          return;
        }

        let html = "";
        scenarios.forEach(function (scenario) {
          const timestamp = new Date(scenario.timestamp).toLocaleString();
          html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${scenario.name}</h6>
                                <small class="text-muted">${timestamp}</small>
                                <br>
                                <small class="text-info">${scenario.params_summary}</small>
                            </div>
                            <div>
                                <input type="checkbox" class="form-check-input scenario-checkbox" 
                                       value="${scenario.id}" id="scenario_${scenario.id}">
                            </div>
                        </div>
                    </div>
                `;
        });

        $("#scenarioListContent").html(html);
      }

      function compareScenarios() {
        selectedScenarios = [];
        $(".scenario-checkbox:checked").each(function () {
          selectedScenarios.push($(this).val());
        });

        if (selectedScenarios.length < 2) {
          alert("Please select at least 2 scenarios to compare");
          return;
        }

        $("#comparisonResults").show();
        $("#comparisonResults").html(
          '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Comparing scenarios...</div>'
        );

        $.ajax({
          url: "/api/scenarios/compare",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ scenario_ids: selectedScenarios }),
          success: function (response) {
            if (response.status === "success") {
              displayComparisonResults(response.comparison);
            } else {
              alert("Error comparing scenarios: " + response.message);
            }
          },
          error: function () {
            alert("Failed to compare scenarios");
          },
        });
      }

      function displayComparisonResults(comparison) {
        let html = "<h5>Scenario Comparison Results</h5>";

        // Summary of best performers
        html += '<div class="alert alert-info mt-3">';
        html += '<h6>Best Performers:</h6>';
        html += `<ul>
          <li><strong>Highest GDP Impact:</strong> ${comparison.analysis.best_gdp_scenario}</li>
          <li><strong>Most Jobs Created:</strong> ${comparison.analysis.best_jobs_scenario}</li>
          <li><strong>Most Clusters:</strong> ${comparison.analysis.most_clusters}</li>
        </ul>`;
        html += '</div>';

        // Metrics comparison table
        html += '<div class="card mt-3"><div class="card-body"><h6>Metrics Comparison</h6>';
        html += '<table class="table table-sm table-hover">';
        html += '<thead><tr><th>Scenario</th><th>GDP Impact</th><th>Total Jobs</th><th>Clusters</th><th>Businesses</th><th>Success Prob.</th></tr></thead><tbody>';
        
        comparison.scenarios.forEach(function (scenario, index) {
          html += '<tr>';
          html += `<td>${scenario.name}</td>`;
          html += `<td>$${(comparison.metrics.gdp_impact[index] / 1e9).toFixed(2)}B</td>`;
          html += `<td>${comparison.metrics.total_jobs[index].toLocaleString()}</td>`;
          html += `<td>${comparison.metrics.total_clusters[index]}</td>`;
          html += `<td>${comparison.metrics.total_businesses[index].toLocaleString()}</td>`;
          html += `<td>${(comparison.metrics.success_probability[index] * 100).toFixed(1)}%</td>`;
          html += '</tr>';
        });
        html += "</tbody></table></div></div>";

        // Add comparison charts placeholder
        html += '<div class="row mt-3">';
        html += '<div class="col-12">';
        html += '<div class="alert alert-secondary text-center">';
        html += '<i class="fas fa-chart-bar"></i> Detailed charts and visualizations can be added here';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        $("#comparisonResults").html(html);
      }

      // Note: This function is currently not used - visualization handled in displayComparisonResults
      function createComparisonCharts(viz) {
        // GDP Comparison
        const gdpTrace = {
          x: viz.gdp_comparison.labels,
          y: viz.gdp_comparison.values,
          type: "bar",
          marker: { color: "lightblue" },
        };

        const gdpLayout = {
          title: "GDP Impact Comparison (Billions $)",
          xaxis: { title: "Scenario" },
          yaxis: { title: "GDP Impact" },
        };

        Plotly.newPlot("gdpComparisonChart", [gdpTrace], gdpLayout);

        // Jobs Comparison
        const jobsData = [
          {
            x: viz.jobs_comparison.labels,
            y: viz.jobs_comparison.direct,
            name: "Direct Jobs",
            type: "bar",
          },
          {
            x: viz.jobs_comparison.labels,
            y: viz.jobs_comparison.total,
            name: "Total Jobs",
            type: "bar",
          },
        ];

        const jobsLayout = {
          title: "Jobs Creation Comparison",
          barmode: "group",
          xaxis: { title: "Scenario" },
          yaxis: { title: "Number of Jobs" },
        };

        Plotly.newPlot("jobsComparisonChart", jobsData, jobsLayout);

        // Target Achievement
        const targetData = [
          {
            x: viz.target_achievement.labels,
            y: viz.target_achievement.gdp,
            name: "GDP Target %",
            type: "bar",
          },
          {
            x: viz.target_achievement.labels,
            y: viz.target_achievement.jobs,
            name: "Jobs Target %",
            type: "bar",
          },
        ];

        const targetLayout = {
          title: "Target Achievement Comparison",
          barmode: "group",
          xaxis: { title: "Scenario" },
          yaxis: { title: "Achievement %" },
        };

        Plotly.newPlot("targetAchievementChart", targetData, targetLayout);

        // Cluster Scores
        const scoresTrace = {
          x: viz.cluster_scores.labels,
          y: viz.cluster_scores.scores,
          type: "bar",
          marker: { color: "lightgreen" },
        };

        const scoresLayout = {
          title: "Top Cluster Scores",
          xaxis: { title: "Scenario" },
          yaxis: { title: "Score" },
        };

        Plotly.newPlot("clusterScoresChart", [scoresTrace], scoresLayout);
      }
      
      // ===================================================================
      // COMPREHENSIVE CONSOLE LOGGING SYSTEM
      // ===================================================================
      
      // Enable debug logging
      window.DEBUG_MODE = true;
      
      // Create enhanced console logger
      window.AnalysisLogger = {
        log: function(category, message, data) {
          if (!window.DEBUG_MODE) return;
          const timestamp = new Date().toISOString();
          console.log(`\n[${category}] ${timestamp}\n${message}`);
          if (data) {
            console.log(JSON.stringify(data, null, 2));
          }
        },
        
        logParameters: function(params) {
          try {
            const ks = params.geographic_scope?.kansas_counties || [];
            const mo = params.geographic_scope?.missouri_counties || [];
            const allCounties = [...ks, ...mo];
            this.log('USER_INPUT', '=== COMPLETE USER PARAMETERS ===', {
              economic_targets: {
                gdp_target: params.economic_targets ? `$${(params.economic_targets.gdp_growth / 1e9).toFixed(2)}B` : 'N/A',
                direct_jobs: params.economic_targets?.direct_jobs || 0,
                indirect_jobs: params.economic_targets?.indirect_jobs || 0,
                wage_growth: params.economic_targets ? `${(params.economic_targets.wage_growth * 100).toFixed(1)}%` : 'N/A',
                time_horizon: params.economic_targets ? `${params.economic_targets.time_horizon} years` : 'N/A',
                min_roi: params.economic_targets ? `${(params.economic_targets.min_roi * 100).toFixed(0)}%` : 'N/A'
              },
              geographic: {
                focus: params.geographic_scope?.focus || 'Not specified',
                counties_count: allCounties.length,
                counties: allCounties
              },
              business_filters: params.business_filters || {},
              algorithm: params.algorithm_params || {},
              infrastructure: params.infrastructure_requirements || {},
              mode: params.quick_mode ? 'Quick' : 'Full'
            });
          } catch (e) {
            console.error('Error logging parameters:', e);
            console.log('Raw parameters:', params);
          }
        },
        
        logResults: function(results) {
          try {
            this.log('OUTPUT', '=== ANALYSIS RESULTS ===', {
              summary: {
                analysis_id: results?.export_id || results?.timestamp || 'N/A',
                total_clusters: results?.total_clusters || 0,
                businesses_analyzed: results?.total_businesses || 0,
                processing_time: results?.processing_time || 'N/A'
              },
              economic_impact: {
                gdp_impact: `$${((results?.economic_impact?.projected_gdp_impact || 0) / 1e9).toFixed(2)}B`,
                direct_jobs: results?.economic_impact?.projected_direct_jobs || 0,
                total_jobs: results?.economic_impact?.projected_total_jobs || 0,
                roi: `${((results?.economic_impact?.roi || 0) * 100).toFixed(1)}%`,
                gdp_achievement: `${(results?.economic_impact?.gdp_target_achievement || 0).toFixed(1)}%`
              }
            });
            
            // Log top clusters
            const clusters = results?.steps?.cluster_optimization?.clusters || [];
            if (clusters.length > 0) {
              this.log('CLUSTERS', `Top ${Math.min(5, clusters.length)} Clusters:`);
              clusters.slice(0, 5).forEach((cluster, idx) => {
                console.log(`\n${idx + 1}. ${cluster?.name || 'Unknown'}`);
                console.log(`   Type: ${cluster?.type || 'N/A'}`);
                console.log(`   Businesses: ${cluster?.business_count || 0}`);
                console.log(`   GDP Impact: $${((cluster?.gdp_impact || 0) / 1e9).toFixed(2)}B`);
                console.log(`   Jobs: ${cluster?.job_creation || 0}`);
        const mlp = cluster?.ml_predictions || {};
        const roiLogPct = (
          (cluster && typeof cluster.roi === 'number') ? cluster.roi * 100 :
          (mlp && typeof mlp.expected_roi === 'number') ? mlp.expected_roi * 100 :
          (mlp && typeof mlp.roi_percentage === 'number') ? mlp.roi_percentage : 0
        );
        console.log(`   ROI: ${roiLogPct.toFixed(1)}%`);
                console.log(`   ML Confidence: ${((cluster?.confidence_score || 0) * 100).toFixed(1)}%`);
              });
            }
          } catch (e) {
            console.error('Error logging results:', e);
            console.log('Raw results:', results);
          }
        },
        
        logError: function(context, error, details) {
          console.error(`\n[ERROR] ${new Date().toISOString()} - ${context}`);
          console.error(error);
          if (details) {
            console.error('Details:', details);
          }
        }
      };
      
      // Intercept key functions to add logging
      const _originalGatherParameters = gatherParameters;
      gatherParameters = function() {
        const params = _originalGatherParameters.apply(this, arguments);
        window.AnalysisLogger.logParameters(params);
        return params;
      };
      
      const _originalDisplayResults = displayResults;
      displayResults = function(results, visualizations) {
        window.AnalysisLogger.logResults(results);
        window.AnalysisLogger.log('VISUALIZATIONS', 'Available visualizations:', 
          Object.keys(visualizations || {}).filter(k => visualizations[k]));
        return _originalDisplayResults.apply(this, arguments);
      };
      
      // Log all AJAX requests
      $(document).ajaxSend(function(event, xhr, settings) {
        if (settings.url.includes('/api/')) {
          window.AnalysisLogger.log('API_REQUEST', `${settings.type} ${settings.url}`);
        }
      });
      
      $(document).ajaxComplete(function(event, xhr, settings) {
        if (settings.url.includes('/api/') && xhr.status === 200) {
          window.AnalysisLogger.log('API_RESPONSE', `${settings.url} - Success`);
        }
      });
      
      $(document).ajaxError(function(event, xhr, settings, error) {
        if (settings.url.includes('/api/')) {
          window.AnalysisLogger.logError(`API Error: ${settings.url}`, error, {
            status: xhr.status,
            response: xhr.responseText
          });
        }
      });
      
      console.log('🔍 Enhanced console logging enabled for KC Cluster Prediction Tool');
      console.log('📊 All user inputs and outputs will be logged');
      console.log('⚙️ Set window.DEBUG_MODE = false to disable logging');
      
      // Initialize global variables for cluster filtering (prevent redeclaration)
      if (typeof window.tooltipData === 'undefined') {
        window.tooltipData = {};
      }
      if (typeof window.clusterData === 'undefined') {
        window.clusterData = [];
      }
      
      // Apply filters function for cluster filtering (prevent redeclaration)
      if (typeof window.applyFilters === 'undefined') {
        window.applyFilters = function() {
          console.log('Applying cluster filters...');
        
        // Get filter values
        // GDP inputs are in $B; convert to dollars for comparison
        const minGDPRaw = parseFloat($('#minGDPFilter').val());
        const maxGDPRaw = parseFloat($('#maxGDPFilter').val());
        const toDollars = (v) => (Number.isFinite(v) ? v * 1e9 : v);
        const minGDP = toDollars(minGDPRaw) || 0;
        const maxGDP = toDollars(maxGDPRaw) || Infinity;
        const minJobs = parseInt($('#minJobsFilter').val()) || 0;
        const maxJobs = parseInt($('#maxJobsFilter').val()) || Infinity;
        const selectedTypes = $('#clusterTypeFilter').val() || [];
        
        console.log('Filter criteria:', { minGDP, maxGDP, minJobs, maxJobs, selectedTypes });
        
        // Filter clusters
        const filteredClusters = window.clusterData.filter(cluster => {
          const gdpImpact = cluster.gdp_impact || cluster.projected_gdp_impact || 0;
          const jobs = cluster.job_creation || cluster.projected_jobs || 0;
          const type = cluster.type || 'unknown';
          
          return gdpImpact >= minGDP && gdpImpact <= maxGDP &&
                 jobs >= minJobs && jobs <= maxJobs &&
                 (selectedTypes.length === 0 || selectedTypes.includes(type));
        });
        
        console.log('Filtered clusters:', filteredClusters.length, 'out of', window.clusterData.length);
        
        // Update cluster display
        displayFilteredClusters(filteredClusters);
        
        // Update map markers if map is visible
        if ($('#mapContainer').is(':visible')) {
          updateMapMarkers(filteredClusters);
        }
        };
      }
      
      // Reset filters function (define only if not already provided by
      // the dynamic initializer to prevent overriding its smarter defaults)
      if (!window.resetFilters) {
        window.resetFilters = function() {
          console.log('Resetting cluster filters...');
          $('#minGDPFilter').val('');
          $('#maxGDPFilter').val('');
          $('#minJobsFilter').val('');
          $('#maxJobsFilter').val('');
          $('#clusterTypeFilter').val([]);

          // Re-apply filters with reset values
          window.applyFilters();
        };
      }
      
      // Initialize cluster filters (fallback). Define only if a dynamic
      // initializer isn’t present; this prevents duplicate panels.
      if (!window.initializeClusterFilters) {
        window.initializeClusterFilters = function() {
          console.log('Initializing cluster filters (fallback)...');

          // Add filter controls to the page
          const filterHtml = `
            <div class="card mb-3" id="clusterFilterCard">
              <div class="card-header">
                <h5><i class="fas fa-filter"></i> Cluster Filters</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <label for="minGDPFilter" class="form-label">Min GDP Impact ($B)</label>
                    <input type="number" class="form-control" id="minGDPFilter" placeholder="0">
                  </div>
                  <div class="col-md-3">
                    <label for="maxGDPFilter" class="form-label">Max GDP Impact ($B)</label>
                    <input type="number" class="form-control" id="maxGDPFilter" placeholder="10">
                  </div>
                  <div class="col-md-3">
                    <label for="minJobsFilter" class="form-label">Min Jobs</label>
                    <input type="number" class="form-control" id="minJobsFilter" placeholder="0">
                  </div>
                  <div class="col-md-3">
                    <label for="maxJobsFilter" class="form-label">Max Jobs</label>
                    <input type="number" class="form-control" id="maxJobsFilter" placeholder="10000">
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-md-6">
                    <label for="clusterTypeFilter" class="form-label">Cluster Types</label>
                    <select class="form-select" id="clusterTypeFilter" multiple>
                      <option value="logistics">Logistics</option>
                      <option value="technology">Technology</option>
                      <option value="biosciences">Biosciences</option>
                      <option value="manufacturing">Manufacturing</option>
                      <option value="animal_health">Animal Health</option>
                      <option value="professional_services">Professional Services</option>
                      <option value="community_services">Community Services</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">&nbsp;</label>
                    <div>
                      <button type="button" class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Apply Filters
                      </button>
                      <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;

          // Insert filter controls before cluster details
          $('#clusterDetailsSection').prepend(filterHtml);

          // Add event listeners for real-time filtering
          $('#minGDPFilter, #maxGDPFilter, #minJobsFilter, #maxJobsFilter, #clusterTypeFilter').on('change', function() {
            window.applyFilters();
          });
        };
      }
      
      // Display filtered clusters
      function displayFilteredClusters(clusters) {
        let html = '';
        
        if (clusters.length === 0) {
          html = '<div class="alert alert-warning">No clusters match the current filters.</div>';
        } else {
          clusters.forEach((cluster, index) => {
            const gdpImpact = cluster.gdp_impact || cluster.projected_gdp_impact || 0;
            const jobs = cluster.job_creation || cluster.projected_jobs || 0;
            const type = cluster.type || 'unknown';

            // Resolve score with sensible fallbacks
            const score = Math.round(
              (cluster.cluster_score != null ? cluster.cluster_score :
               (cluster.total_score != null ? cluster.total_score :
                (cluster.ml_composite_score != null ? cluster.ml_composite_score : 0)))
            );

            // Resolve ROI (prefer normalized fraction, fallback to % from ML)
            const roiFraction = (cluster.roi != null && !isNaN(cluster.roi))
              ? cluster.roi
              : (cluster.ml_predictions && cluster.ml_predictions.expected_roi != null && !isNaN(cluster.ml_predictions.expected_roi))
                ? cluster.ml_predictions.expected_roi
                : (cluster.ml_predictions && cluster.ml_predictions.roi_percentage != null && !isNaN(cluster.ml_predictions.roi_percentage))
                  ? (cluster.ml_predictions.roi_percentage / 100)
                  : 0;
            
            html += `
              <div class="cluster-detail-card">
                <h5>${index + 1}. ${cluster.name}</h5>
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Type:</strong> ${type}</p>
                    <p><strong>Businesses:</strong> ${cluster.business_count || 0}</p>
                    <p><strong>GDP Impact:</strong> $${(gdpImpact / 1e9).toFixed(2)}B</p>
                    <p><strong>Jobs:</strong> ${jobs.toLocaleString()}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Score:</strong> ${score}/100</p>
                    <p><strong>ROI:</strong> ${(roiFraction * 100).toFixed(1)}%</p>
                    <p><strong>Risk:</strong> ${cluster.risk_score ? (cluster.risk_score < 30 ? 'Low' : cluster.risk_score < 60 ? 'Medium' : 'High') : 'Medium'}</p>
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        $('#clusterDetailsList').html(html);
      }
      
      // Update map markers for filtered clusters
      function updateMapMarkers(clusters) {
        // This function would update the map markers
        // Implementation depends on the map library being used
        console.log('Updating map markers for', clusters.length, 'clusters');
      }
    </script>
  </body>
</html>
<!-- Diagnostics loader removed - simplified UI -->



